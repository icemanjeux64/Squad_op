<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F.O.F TACTICAL NET</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles & Tailwind Config -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap');
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #050505;
            color: #cbd5e1; /* slate-300 */
        }

        /* Scrollbar Tactique */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f1419; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glitch-effect {
            text-shadow: 2px 0 #7f1d1d, -2px 0 #047857;
        }
        
        .military-box {
            position: relative;
            background-color: #0f1419;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .military-box::before, .military-box::after {
            content: ''; position: absolute; width: 8px; height: 8px; pointer-events: none; transition: all 0.3s;
        }
        /* Coins */
        .corner-tl { position: absolute; top: -1px; left: -1px; width: 8px; height: 8px; border-top: 2px solid rgba(255,255,255,0.3); border-left: 2px solid rgba(255,255,255,0.3); }
        .corner-tr { position: absolute; top: -1px; right: -1px; width: 8px; height: 8px; border-top: 2px solid rgba(255,255,255,0.3); border-right: 2px solid rgba(255,255,255,0.3); }
        .corner-bl { position: absolute; bottom: -1px; left: -1px; width: 8px; height: 8px; border-bottom: 2px solid rgba(255,255,255,0.3); border-left: 2px solid rgba(255,255,255,0.3); }
        .corner-br { position: absolute; bottom: -1px; right: -1px; width: 8px; height: 8px; border-bottom: 2px solid rgba(255,255,255,0.3); border-right: 2px solid rgba(255,255,255,0.3); }

        .animate-pulse-fast { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* Background Grid */
        .bg-grid {
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }

        /* Custom Input for touch */
        .touch-input {
            height: 50px;
            font-size: 16px;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mil-black': '#050505',
                        'mil-dark': '#0f1419',
                        'mil-green': '#10b981',
                        'mil-red': '#ef4444',
                        'mil-yellow': '#eab308',
                        'mil-cyan': '#66fcf1',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <!-- Container Principal -->
    <div id="app" class="flex-1 relative flex flex-col h-full">
        <!-- Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 z-50 bg-mil-black flex items-center justify-center">
            <div class="text-center">
                <div class="text-mil-cyan font-black text-2xl tracking-[0.5em] animate-pulse">INITIALISATION...</div>
                <div class="text-slate-600 text-xs mt-2 font-mono">CONNEXION SECURE FIREBASE</div>
            </div>
        </div>
    </div>

    <!-- TEMPLATES (Hidden, used by JS to render) -->
    
    <!-- 1. LOGIN / LANDING -->
    <template id="tpl-landing">
        <div class="absolute inset-0 bg-grid pointer-events-none"></div>
        <div class="relative z-10 flex flex-col items-center justify-center h-full p-4 overflow-y-auto">
            
            <!-- Titre -->
            <div class="text-center mb-12">
                <h1 class="text-6xl md:text-8xl font-black text-white uppercase tracking-tighter mb-2 glitch-effect select-none">
                    <span class="text-red-700">FOF</span>NET
                </h1>
                <div class="flex justify-center gap-4 text-[10px] uppercase tracking-[0.3em] text-slate-500">
                    <span>Secure V.3.6.3</span><span>•</span><span>Ops Center</span><span>•</span><span class="text-emerald-500 animate-pulse">Online</span>
                </div>
            </div>

            <!-- Grille Choix -->
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 max-w-6xl w-full">
                <!-- Bouton Staff -->
                <div class="md:col-span-3">
                    <button onclick="window.app.openLoginModal('STAFF')" class="military-box w-full h-32 hover:border-red-600 hover:bg-red-900/10 transition-all group p-6 flex flex-col items-center justify-center cursor-pointer">
                        <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                        <i data-lucide="shield" class="w-10 h-10 text-slate-600 group-hover:text-red-600 mb-2 transition-colors"></i>
                        <span class="text-sm font-bold text-slate-400 group-hover:text-white uppercase tracking-widest">État-Major</span>
                    </button>
                </div>

                <!-- Grille Squads -->
                <div class="md:col-span-9 grid grid-cols-2 md:grid-cols-4 gap-3" id="squad-grid-landing">
                    <!-- Injecté via JS -->
                </div>
            </div>
        </div>

        <!-- Modal Login -->
        <div id="login-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="military-box p-8 max-w-md w-full border-white/20">
                <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                <button onclick="window.app.closeModal()" class="absolute top-2 right-2 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
                
                <div id="modal-content" class="text-center">
                    <!-- Injecté via JS -->
                </div>
            </div>
        </div>
    </template>

    <!-- 2. INTERFACE STAFF (EM) -->
    <template id="tpl-staff">
        <div class="flex flex-col h-full bg-[#0b0c10]">
            <!-- Header -->
            <header class="bg-[#1f2833] border-b border-[#45a29e]/30 p-2 flex flex-col shadow-lg z-20 shrink-0">
                <div class="flex justify-between items-center mb-2">
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2 px-4 border-r border-slate-600">
                            <i data-lucide="shield" class="text-red-600 w-6 h-6"></i>
                            <span class="font-bold text-white tracking-widest uppercase hidden md:inline">QG TACTIQUE</span>
                        </div>
                        
                        <!-- Settings EM -->
                        <div class="flex gap-2 md:gap-4 items-center">
                            <div class="flex flex-col">
                                <label class="text-[9px] text-[#66fcf1] uppercase">Base</label>
                                <select id="em-base-select" onchange="window.app.updateSettings('base', this.value)" class="bg-[#0b0c10] text-white border border-slate-600 text-xs py-1 px-2 uppercase outline-none focus:border-[#66fcf1]">
                                    <!-- Options Bases -->
                                </select>
                            </div>
                            <div class="flex flex-col w-24 md:w-32">
                                <label class="text-[9px] text-slate-400 uppercase">Adjoint</label>
                                <input type="text" onchange="window.app.updateSettings('adjoint', this.value)" id="em-adjoint-input" class="bg-[#0b0c10] text-white border border-slate-600 text-xs py-1 px-2 uppercase outline-none" list="sl-suggestions">
                            </div>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button onclick="window.app.addCDS()" class="bg-[#66fcf1]/10 text-[#66fcf1] px-3 py-1 text-xs font-bold border border-[#66fcf1]/50 hover:bg-[#66fcf1]/20 transition flex items-center gap-1">
                            <i data-lucide="plus"></i> CDS
                        </button>
                        <!-- Effectifs Display -->
                        <div class="text-right hidden sm:block">
                            <div class="text-[9px] text-slate-500 uppercase font-bold">Effectifs</div>
                            <div id="total-effectif" class="text-xl font-bold text-[#66fcf1] leading-none">0</div>
                        </div>
                        <button onclick="window.app.logout()" class="bg-red-900/20 text-red-200 p-2 border border-red-900/50 hover:bg-red-900/50 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                    </div>
                </div>

                <!-- ZONE CHEFS DE SECTION (CDS) -->
                <div id="cds-container" class="flex flex-wrap gap-2 w-full px-2 pb-2 empty:hidden border-t border-white/5 pt-2">
                    <!-- Injecté via JS -->
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 p-2 overflow-hidden flex gap-2">
                <!-- Grid Squads -->
                <div class="flex-1 overflow-y-auto pr-1" id="staff-squad-grid">
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-2" id="squad-container">
                        <!-- Squad Cards Injected Here -->
                    </div>
                </div>

                <!-- Sidebar Logs -->
                <div class="hidden lg:flex w-72 flex-col gap-2">
                    <!-- Stats -->
                    <div class="military-box h-1/3 flex flex-col p-0">
                        <div class="bg-white/5 text-[10px] uppercase font-bold tracking-[0.2em] text-white/50 px-2 py-1 border-b border-white/5 flex items-center gap-2"><div class="w-1 h-3 bg-red-600"></div> CLASSEMENT</div>
                        <div class="overflow-y-auto flex-1 p-2" id="leaderboard-container"></div>
                    </div>
                    <!-- Logs -->
                    <div class="military-box flex-1 flex flex-col p-0">
                        <div class="bg-white/5 text-[10px] uppercase font-bold tracking-[0.2em] text-white/50 px-2 py-1 border-b border-white/5 flex items-center gap-2"><div class="w-1 h-3 bg-red-600"></div> FLUX OPS</div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-2" id="logs-container"></div>
                    </div>
                </div>
            </main>
        </div>

        <!-- Modal Détail Rapport -->
        <div id="report-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="military-box p-6 max-w-lg w-full border-white/20 flex flex-col max-h-[90vh]">
                <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                <div class="flex justify-between items-center mb-4 border-b border-white/10 pb-2">
                    <h3 class="text-xl font-black text-white uppercase tracking-widest flex items-center gap-2">
                        <i data-lucide="file-text" class="text-[#66fcf1]"></i> RAPPORT DE MISSION
                    </h3>
                    <button onclick="window.app.closeReportModal()"><i data-lucide="x" class="w-6 h-6 text-slate-500 hover:text-white"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto mb-4 pr-2 bg-black/30 border border-white/5 p-4 custom-scrollbar">
                    <div id="report-modal-content" class="text-sm font-mono text-slate-300 whitespace-pre-wrap"></div>
                </div>
                <button onclick="window.app.copyReport()" class="w-full bg-white/10 hover:bg-white/20 text-white font-bold py-3 border border-white/30 flex items-center justify-center gap-2 uppercase tracking-widest transition">
                    <i data-lucide="copy" class="w-4 h-4"></i> Copier le rapport
                </button>
            </div>
        </div>
    </template>

    <!-- 3. INTERFACE SQUAD LEADER (SL) -->
    <template id="tpl-sl">
        <div class="flex flex-col h-full bg-[#050505]">
            <!-- Top Bar -->
            <div class="bg-[#1a1c23] p-2 flex justify-between items-center text-[10px] uppercase border-b border-white/5 shrink-0">
                <div class="flex gap-4 text-slate-400">
                    <span>BASE: <span class="text-white font-bold" id="sl-base-display">N/A</span></span>
                    <span>ADC: <span class="text-white font-bold" id="sl-adjoint-display">N/A</span></span>
                </div>
                <button onclick="window.app.logout()" class="text-red-500 font-bold border border-red-900/50 px-2 hover:bg-red-900/20">DÉCONNEXION</button>
            </div>

            <!-- Header Mission -->
            <div id="sl-header" class="p-4 bg-opacity-20 border-b border-white/10 flex justify-between items-end shrink-0 transition-colors duration-300">
                <div>
                    <h2 class="text-4xl font-black uppercase text-white tracking-tighter" id="sl-squad-name">ALPHA</h2>
                    <div class="flex items-center gap-3 text-xs font-bold text-white/50">
                        <span class="flex items-center gap-1 bg-black/30 px-2 py-1"><i data-lucide="radio" class="w-3 h-3"></i> <span id="sl-freq">00.0</span> MHz</span>
                        <span class="flex items-center gap-1 bg-black/30 px-2 py-1"><i data-lucide="user" class="w-3 h-3"></i> <span id="sl-username">...</span></span>
                    </div>
                </div>
                <div class="text-right">
                    <div id="sl-rtb-status"></div>
                    <div class="text-[10px] uppercase text-white/40 mb-1 tracking-widest">Objectif</div>
                    <div class="text-2xl font-black text-white bg-white/5 px-3 py-1 border-l-4 border-yellow-500 uppercase" id="sl-objective">STANDBY</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-white/10 bg-[#0a0a0a] shrink-0" id="sl-tabs">
                <button onclick="window.app.setTab('TACTIQUE')" class="tab-btn flex-1 py-4 text-xs font-bold uppercase tracking-[0.15em] border-r border-white/5 hover:bg-white/5 text-slate-500" data-tab="TACTIQUE">TACTIQUE</button>
                <button onclick="window.app.setTab('ESCOUADE')" class="tab-btn flex-1 py-4 text-xs font-bold uppercase tracking-[0.15em] border-r border-white/5 hover:bg-white/5 text-slate-500" data-tab="ESCOUADE">ESCOUADE</button>
                <button onclick="window.app.setTab('RAPPORT')" class="tab-btn flex-1 py-4 text-xs font-bold uppercase tracking-[0.15em] border-r border-white/5 hover:bg-white/5 text-slate-500" data-tab="RAPPORT">RAPPORT</button>
                <button onclick="window.app.setTab('LIAISON')" id="tab-liaison" class="tab-btn flex-1 py-4 text-xs font-bold uppercase tracking-[0.15em] hidden border-r border-white/5 hover:bg-white/5 text-indigo-500 bg-indigo-900/10" data-tab="LIAISON">LIAISON</button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto p-4 bg-[#0d0e12] relative" id="sl-content">
                <!-- Injected by JS -->
            </div>
        </div>

        <!-- Modal SITREP Form -->
        <div id="sitrep-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="military-box w-full max-w-md p-6 border-white/30 bg-[#0f1419] shadow-2xl">
                <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-2">
                    <h3 class="text-xl font-black text-white uppercase tracking-widest" id="sitrep-title">RAPPORT</h3>
                    <button onclick="window.app.closeSitrepModal()"><i data-lucide="x" class="w-8 h-8 text-slate-500 hover:text-white"></i></button>
                </div>
                <div id="sitrep-form-content" class="space-y-6"></div>
                <button onclick="window.app.submitSitrep()" class="w-full bg-white text-black font-black uppercase py-4 hover:bg-slate-200 transition-colors tracking-widest mt-6 text-lg">TRANSMETTRE</button>
            </div>
        </div>
    </template>

    <!-- Firebase Modules & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, orderBy, addDoc, serverTimestamp, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- CONSTANTES ---
        const STAFF_LIST = ["MJR.Lazarevic", "WhiZzper", "Papa Yankee", "Le_S", "teckilgfx", "Eksypa", "GlockTrooper77", "Pitivier le vrai"];
        const OBJECTIVES = ["ALABAMA", "ALASKA", "ARIZONA", "ARKANSAS", "APOLLO", "AMBER", "AUGUSTA", "ATLAS", "AUSTIN", "BALTIMORE", "BROOKLYN", "CALIFORNIA", "CHICAGO", "COLORADO", "CONCORDE", "CONNECTICUT", "DALLAS", "DAYTON", "DELAWARE", "DENVER", "FLORIDA", "FRESNO", "GEORGIA", "HAWAI", "HOUSTON", "IDAHO", "ILLINOIS", "INDIANA", "IOWA", "JUNKYARD", "KANSAS", "KENTUCKY", "LAS VEGAS", "LIBERTY", "LOGISTIQUE", "LOS ANGELES", "LOUISIANA", "MAINE", "MARYLAND", "MASSACHUSETTS", "MIAMI", "MICHIGAN", "MINNESOTA", "MISSISSIPPI", "MISSOURI", "MONTANA", "MONROE", "NASHVILLE", "NEBRASKA", "NEVADA", "NEW HAMPSHIRE", "NEW JERSEY", "NEW MEXICO", "NEW ORLEANS", "NEW YORK", "NORTH CAROLINA", "NORTH DAKOTA", "OHIO", "OKLAHOMA", "OMAHA", "OREGON", "PENNSYLVANIA", "PHILADELPHIA", "PHOENIX", "PORTLAND", "PRINCETON", "PROVIDENCE", "REDHAWK", "RELAI DE L'EST", "RELAI ST PHILIPPE", "RICHEMOND", "RHODE ISLAND", "SAN ANTONIO", "SAN DIEGO", "SAN JOSE", "SEATTLE", "SOUTH CAROLINA", "SOUTH DAKOTA", "SPIRIT", "TAMPA", "TENNESSEE", "TEXAS", "TITAN", "TOUR D'ENTRE-DEUX", "TOUR DE REGINA", "TOUR DES PINS", "TOUR ESTRAPADE", "TUCSON", "TULSA", "UTAH", "VERMONT", "VESPER", "VIRGINIA", "WASHINGTON", "WEST VIRGINIA", "WISCONSIN", "WYOMING", "DEFENSE DE BASE", "SECURITE EM", "RECONNAISSANCE", "DEMINAGE"];
        const SQUADS_CONFIG = [
            { id: 'alpha', name: 'Alpha', freq: '32.0', color: 'bg-emerald-800', border: 'border-emerald-600', text: 'text-emerald-500' },
            { id: 'bravo', name: 'Bravo', freq: '33.0', color: 'bg-blue-900', border: 'border-blue-600', text: 'text-blue-500' },
            { id: 'charlie', name: 'Charlie', freq: '34.0', color: 'bg-violet-900', border: 'border-violet-600', text: 'text-violet-500' },
            { id: 'delta', name: 'Delta', freq: '35.0', color: 'bg-amber-900', border: 'border-amber-600', text: 'text-amber-500' },
            { id: 'echo', name: 'Echo', freq: '36.0', color: 'bg-teal-900', border: 'border-teal-600', text: 'text-teal-500' },
            { id: 'foxtrot', name: 'Foxtrot', freq: '37.0', color: 'bg-orange-900', border: 'border-orange-600', text: 'text-orange-500' },
            { id: 'golf', name: 'Golf', freq: '38.0', color: 'bg-rose-900', border: 'border-rose-600', text: 'text-rose-500' },
            { id: 'hotel', name: 'Hotel', freq: '39.0', color: 'bg-slate-700', border: 'border-slate-500', text: 'text-slate-400' },
            { id: 'logis', name: 'Logis', freq: '45.0', color: 'bg-yellow-900', border: 'border-yellow-700', text: 'text-yellow-600' },
            { id: 'blindé', name: 'Blindé', freq: '65.0', color: 'bg-stone-800', border: 'border-stone-500', text: 'text-stone-400' },
            { id: 'faucon', name: 'Faucon', freq: '47.0', color: 'bg-sky-900', border: 'border-sky-600', text: 'text-sky-500' },
        ];
        const GRADES = ["Recrue", "Sdt", "1.Cl", "Cpl", "Cch", "Sgt", "Sgt-C", "Adj", "Adj-C", "Maj", "Aspi", "S-Lt", "Lt", "Cne"];
        const ROLES = ["Fusilier", "Médic", "AT", "MG", "Radio", "Sapeur", "Sniper", "Pilote", "Chef de Groupe"];
        
        // Liste de suggestion SL
        const BASE_SL_SUGGESTIONS = ["Nico75", "-Sangui-", "[VDK]KEBABIERdu96", "ALEX2801CH", "ATOMIC W4RRIOR", "Benjamin", "Can am", "CCH.Le_S", "Darkspartan9337", "EagleClaw", "Fez", "Five Scream", "Flo.", "Gin", "Hybris95", "Jej", "KenBlook5129", "l Ryüjinn l", "Lapuchk6766", "LittleEvil", "lkurd26", "MASKER84", "Mirai", "MULTIFRUIT1492", "Natrium", "Nettoyeur", "oahhmz", "Panchito6097", "Pixc361", "Pokeur", "Poulet998", "Sucreblé", "Tatar", "Teckil", "TF3 SLAYER", "Théotime", "Tinky Winky", "Tong", "valoche_0", "ValouTekmi", "Waze toxic", "Exam94", "xYourGalactic-I", "Yogun", "Zl Deathstro", "zlatanqlf"];

        // --- FIREBASE INIT ---
        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD3caoQgjcnsyyh-fCSFHwbErPpPvip8p4",
            authDomain: "squadnet-ops.firebaseapp.com",
            projectId: "squadnet-ops",
            storageBucket: "squadnet-ops.firebasestorage.app",
            messagingSenderId: "453589699258",
            appId: "1:453589699258:web:85befe0f3da6495c685083",
            measurementId: "G-103J7PX3NF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'squadnet-ops';

        // --- STATE MANAGEMENT SIMPLE ---
        const state = {
            user: null,
            role: null, // 'STAFF' ou 'SL'
            view: 'LANDING',
            pseudo: localStorage.getItem('fof_ops_pseudo') || '',
            squads: {},
            opSettings: {},
            logs: [],
            slTab: 'TACTIQUE',
            activeSitrepForm: null,
            sitrepData: {},
            selectedSquadId: null,
            activeReportId: null
        };

        // --- APP LOGIC ---
        const App = {
            init: function() {
                this.bindEvents();
                this.initAuth();
                this.render();
            },

            bindEvents: function() {
                window.app = this;
            },

            initAuth: async function() {
                onAuthStateChanged(auth, (u) => {
                    state.user = u;
                    if (u) {
                        this.startListeners();
                        if (state.pseudo && state.view === 'LANDING') {
                            setTimeout(() => this.checkAutoLogin(), 1000); 
                        }
                    }
                    this.render();
                });

                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); } 
                    catch (e) { await signInAnonymously(auth); }
                } else {
                    await signInAnonymously(auth);
                }
            },

            startListeners: function() {
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'squads'), (snapshot) => {
                    const data = {};
                    snapshot.docs.forEach(doc => data[doc.id] = doc.data());
                    state.squads = data;
                    this.checkAutoLogin();
                    this.render();
                });
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'ops'), (d) => {
                    state.opSettings = d.data() || {};
                    this.render();
                });
                const qLogs = query(collection(db, 'artifacts', appId, 'public', 'data', 'mission_logs'), orderBy('timestamp', 'desc'));
                onSnapshot(qLogs, (snapshot) => {
                    state.logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.render();
                });
            },

            checkAutoLogin: function() {
                if (state.view !== 'LANDING' || !state.pseudo) return;
                const myActiveSquad = Object.entries(state.squads).find(([id, s]) => s.sl === state.pseudo && s.status === 'ACTIVE');
                if (myActiveSquad) {
                    state.role = 'SL';
                    state.view = 'SL';
                    this.render();
                } else if (STAFF_LIST.includes(state.pseudo)) {
                    // Optional auto-login staff
                }
            },

            // --- EM LOGIC ---
            toggleCDS: async function(squadId, cdsIndex) {
                const squad = state.squads[squadId] || {};
                const currentCds = `CDS ${cdsIndex}`;
                const newCds = (squad.cds_owner === currentCds) ? null : currentCds;
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), { cds_owner: newCds }, { merge: true });
            },
            
            addCDS: async function() {
                const count = (state.opSettings.active_cds_count || 0) + 1;
                await this.updateSettings('active_cds_count', count);
            },

            // --- REPORT GENERATOR ---
            generateMilitaryReport: function(squad, userNote) {
                let report = `RAPPORT DE MISSION / PATROUILLE\n`;
                report += `=================================\n`;
                report += `UNITÉ : ${squad.name} (${squad.sl})\n`;
                report += `OBJECTIF : ${squad.objective || 'N/A'}\n`;
                report += `DATE : ${new Date().toLocaleDateString()}\n\n`;
                
                report += `1. IDENTIFICATION / EFFECTIFS\n`;
                report += `- Chef de Groupe : ${squad.sl}\n`;
                report += `- Effectif total : ${squad.effectif}\n`;
                if (squad.members && squad.members.length > 0) {
                    report += `- Pax : ${squad.members.map(m => `${m.grade} ${m.name} (${m.role})`).join(', ')}\n`;
                }
                report += `\n`;

                report += `2. CHRONOLOGIE DES ÉVÉNEMENTS\n`;
                const history = squad.missionHistory || [];
                if (history.length === 0) {
                    report += `- R.A.S (Aucun événement noté)\n`;
                } else {
                    history.forEach(h => {
                        const time = new Date(h.time).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                        let content = h.content;
                        
                        if (content.startsWith('CONTACT:')) content = content.replace('CONTACT:', 'CONTACT ENNEMI -');
                        else if (content.startsWith('SANITAIRE:')) content = content.replace('SANITAIRE:', 'BILAN SANITAIRE -');
                        else if (content.startsWith('LOG:')) content = content.replace('LOG:', 'DEMANDE LOGISTIQUE -');
                        else if (content === 'DÉPART MISSION') content = 'DÉPART MISSION - SORTIE DE BASE';
                        else if (content === 'RETOUR BASE') content = 'RETOUR BASE - FIN DE MOUVEMENT';

                        report += `[${time}] ${content}\n`;
                    });
                }
                report += `\n`;

                report += `3. SYNTHÈSE / CONCLUSION\n`;
                report += `${userNote || "Aucune note particulière ajoutée."}\n`;
                report += `=================================\n`;
                return report;
            },

            // --- ACTIONS ---
            openLoginModal: function(type) {
                const modal = document.getElementById('login-modal');
                const content = document.getElementById('modal-content');
                if(!modal || !content) return;
                
                modal.classList.remove('hidden');
                
                let html = '';
                if (type === 'STAFF') {
                    html = `
                        <div class="mb-6"><i data-lucide="shield" class="w-16 h-16 text-red-700 mx-auto"></i><h2 class="text-xl font-bold text-white uppercase">Accès EM</h2></div>
                        <input type="text" id="login-pseudo" class="w-full bg-black border border-slate-700 p-4 text-white text-center outline-none mb-4 uppercase" placeholder="IDENTIFIANT" value="${state.pseudo}">
                        <button onclick="window.app.login('STAFF')" class="w-full bg-red-900/80 hover:bg-red-800 text-white font-bold py-3 border border-red-700">CONNEXION</button>
                    `;
                } else if (type === 'SL') {
                    const squad = SQUADS_CONFIG.find(s => s.id === state.selectedSquadId);
                    const sData = state.squads[state.selectedSquadId] || {};
                    const isAssigned = sData.status === 'ASSIGNED';
                    
                    html = `
                        <div class="mb-6"><i data-lucide="target" class="w-16 h-16 text-emerald-600 mx-auto"></i><h2 class="text-xl font-bold text-white uppercase">ID SQUAD LEADER</h2><div class="text-emerald-500 font-bold">${squad ? squad.name : '...'}</div></div>
                    `;

                    if (isAssigned) {
                        html += `
                            <p class="text-slate-500 text-xs uppercase mb-2">Opérateur Assigné</p>
                            <div class="text-2xl font-bold text-white bg-white/5 p-4 border border-white/10 mb-6">${sData.sl}</div>
                            <button onclick="window.app.login('SL_CONFIRM')" class="w-full bg-emerald-900/80 hover:bg-emerald-800 text-white font-bold py-3 border border-emerald-700">CONFIRMER IDENTITÉ</button>
                        `;
                    } else {
                        html += `
                            <div class="relative mb-4">
                                <input list="sl-suggestions-list" type="text" id="login-pseudo" class="w-full bg-black border border-slate-700 p-4 text-white text-center outline-none uppercase" placeholder="VOTRE GAMERTAG" value="${state.pseudo}">
                                <datalist id="sl-suggestions-list">${BASE_SL_SUGGESTIONS.map(s => `<option value="${s}">`).join('')}</datalist>
                            </div>
                            <div id="new-profile-alert" class="text-xs text-yellow-500 mb-4 hidden">Nouveau profil détecté</div>
                            <button onclick="window.app.login('SL_MANUAL')" class="w-full bg-blue-900/80 hover:bg-blue-800 text-white font-bold py-3 border border-blue-700">VALIDER</button>
                        `;
                    }
                }
                content.innerHTML = html;
                lucide.createIcons();
            },

            openSLLogin: function(squadId) {
                state.selectedSquadId = squadId;
                this.openLoginModal('SL');
            },

            closeModal: function() {
                document.getElementById('login-modal').classList.add('hidden');
                state.selectedSquadId = null;
            },

            login: async function(mode) {
                const pseudoInput = document.getElementById('login-pseudo');
                const pseudo = pseudoInput ? pseudoInput.value.trim() : state.squads[state.selectedSquadId]?.sl;
                
                if (!pseudo) return alert("Identifiant requis");

                if (mode === 'STAFF') {
                    if (!STAFF_LIST.some(n => n.toLowerCase() === pseudo.toLowerCase())) return alert("Accès refusé");
                    state.role = 'STAFF';
                    state.view = 'STAFF';
                } else {
                    // SL Login
                    const squadId = state.selectedSquadId;
                    const squadData = state.squads[squadId] || {};
                    
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), {
                        ...squadData,
                        sl: pseudo,
                        name: SQUADS_CONFIG.find(s => s.id === squadId).name,
                        startTime: new Date().toISOString(),
                        status: 'ACTIVE',
                        members: squadData.members || [],
                        missionHistory: []
                    }, { merge: true });

                    state.role = 'SL';
                    state.view = 'SL';
                }

                state.pseudo = pseudo;
                localStorage.setItem('fof_ops_pseudo', pseudo);
                this.closeModal();
                this.render();
            },

            logout: function() {
                state.role = null;
                state.view = 'LANDING';
                state.pseudo = '';
                state.slTab = 'TACTIQUE';
                localStorage.removeItem('fof_ops_pseudo');
                this.render();
            },

            // --- UPDATES & ACTIONS ---

            updateSettings: async function(key, val) {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'ops'), {
                    ...state.opSettings, [key]: val
                }, { merge: true });
            },

            updateSquad: async function(squadId, field, val) {
                const currentSquad = state.squads[squadId] || {};
                const updates = { [field]: val };
                // Logic reset
                if (field === 'sl') {
                    if (val === "") {
                        updates.status = 'DISPO';
                        updates.startTime = null;
                        updates.sitrep = '';
                        updates.rtbStatus = 'NONE';
                        updates.junctionFreq = '';
                    } else if (currentSquad.status !== 'ACTIVE') {
                        updates.status = 'ASSIGNED';
                        updates.startTime = null;
                    }
                }
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), updates, { merge: true });
            },

            endMission: async function(squadId, report = "R.A.S", outcome = "UNKNOWN") {
                const sData = state.squads[squadId] || {};
                
                // Generation du rapport final propre avec le générateur (pas de undefined ici)
                const reportFull = (typeof report === 'string' && report.length > 0) ? report : this.generateMilitaryReport(sData, "");

                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mission_logs'), {
                    sl: sData.sl, squad: sData.name, objective: sData.objective || 'N/A', // Fallback si undefined
                    startTime: sData.startTime || new Date().toISOString(), 
                    endTime: new Date().toISOString(),
                    report: reportFull, 
                    timestamp: serverTimestamp(), 
                    managedBy: state.pseudo,
                    outcome: outcome // Success/Failure
                });
                // Reset
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), {
                    sl: '', objective: '', status: 'DISPO', startTime: null, sitrep: '',
                    members: [], missionHistory: [], rtbStatus: 'NONE', junctionFreq: '', cds_owner: null
                });
                
                if (state.role === 'SL') this.logout();
            },

            // --- SL ACTIONS ---
            
            setTab: function(tab) {
                state.slTab = tab;
                this.render();
            },

            openSitrepModal: function(formType, defaultLabel) {
                state.activeSitrepForm = formType;
                state.sitrepData = { defaultMsg: defaultLabel };
                this.renderSitrepModal();
                document.getElementById('sitrep-modal').classList.remove('hidden');
            },

            closeSitrepModal: function() {
                document.getElementById('sitrep-modal').classList.add('hidden');
                state.activeSitrepForm = null;
            },

            requestRTB: async function(squadId) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), {
                    rtbStatus: 'REQUESTED',
                    sitrep: 'DEMANDE DE RTB',
                    missionHistory: arrayUnion({ type: 'ALERT', content: "REQ RTB", time: new Date().toISOString() })
                });
            },

            approveRTB: async function(squadId, approved) {
                const status = approved ? 'APPROVED' : 'DENIED';
                const msg = approved ? 'RTB ACCORDÉ' : 'RTB REFUSÉ - MAINTENEZ POSITION';
                
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), { 
                    rtbStatus: status,
                    missionHistory: arrayUnion({ type: 'CMD', content: msg, time: new Date().toISOString() })
                });
            },

            submitSitrep: async function() {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                if (!squadId) return;

                let msg = "";
                const data = state.sitrepData;
                
                // Build message based on form inputs (collected via onchange events stored in state.sitrepData via DOM)
                const getVal = (id) => document.getElementById(id)?.value || '';
                const getCheck = (id) => document.getElementById(id)?.checked;

                if (state.activeSitrepForm === 'CONTACT') {
                    msg = `CONTACT: ${getVal('sr-count')}x ${getVal('sr-type')} (${getVal('sr-attitude')}) | Dist: ${getVal('sr-dist')}m | Azi: ${getVal('sr-azi')}`;
                } else if (state.activeSitrepForm === 'MEDICAL') {
                    msg = `SANITAIRE: A:${getVal('sr-alpha')} / B:${getVal('sr-bravo')} | EVASAN: ${getCheck('sr-evasan')?'OUI':'NON'} | LZ: ${getVal('sr-lz')}`;
                } else if (state.activeSitrepForm === 'LOG') {
                    msg = `LOG: ${getVal('sr-item')} (${getVal('sr-urgency')}) à ${getVal('sr-loc')}`;
                } else {
                    msg = getVal('sr-manual') || data.defaultMsg;
                }

                const timestamp = new Date().toISOString();
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), {
                    sitrep: msg, lastSitrepTime: timestamp,
                    missionHistory: arrayUnion({ type: 'SITREP', content: msg, time: timestamp })
                });

                this.closeSitrepModal();
            },

            addMember: async function() {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                const members = state.squads[squadId].members || [];
                if (members.length >= 10) return;
                members.push({ name: 'SOLDAT', grade: 'Sdt', role: 'Fusilier' });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), { members, effectif: members.length });
            },

            updateMember: async function(idx, field, val) {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                const members = [...state.squads[squadId].members];
                members[idx][field] = val;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), { members });
            },

            removeMember: async function(idx) {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                const members = state.squads[squadId].members.filter((_, i) => i !== idx);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), { members, effectif: members.length });
            },

            sitrepAction: function(id, form, label) {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                if (id === 'rtb') {
                    if(confirm("Demander RTB à l'EM ?")) this.requestRTB(squadId);
                } else if (id === 'depart') {
                    this.submitSitrepDirect(squadId, 'DÉPART MISSION');
                } else if (id === 'retour') {
                    this.submitSitrepDirect(squadId, 'RETOUR BASE');
                } else {
                    this.openSitrepModal(form, label);
                }
            },
            
            submitSitrepDirect: async function(squadId, msg) {
                const ts = new Date().toISOString();
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), {
                    sitrep: msg, lastSitrepTime: ts, missionHistory: arrayUnion({ type: 'SITREP', content: msg, time: ts })
                });
            },

            sendEndMission: function() {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                const note = document.getElementById('final-report-input').value;
                const status = document.querySelector('input[name="mission-status"]:checked').value;
                if(confirm("Clôturer la mission ?")) this.endMission(squadId, note, status);
            },

            // --- REPORT MODAL ACTIONS (STAFF) ---
            openReportModal: function(logId) {
                state.activeReportId = logId;
                const log = state.logs.find(l => l.id === logId);
                if(!log) return;

                const modal = document.getElementById('report-modal');
                const content = document.getElementById('report-modal-content');
                
                modal.classList.remove('hidden');
                const dateStr = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleDateString() : '';
                const timeStr = log.timestamp ? new Date(log.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '';

                content.innerHTML = `
                    <div class="flex items-center justify-between gap-2 mb-2 border-b border-white/10 pb-2 text-xs uppercase tracking-wider">
                        <div class="flex items-center gap-2">
                             <span class="text-slate-500">${timeStr}</span>
                             <span class="font-black text-white">${log.squad}</span>
                             <span class="text-[#66fcf1] font-bold">${log.sl}</span>
                        </div>
                        <div class="flex items-center gap-2">
                             <span class="font-bold text-slate-300 truncate max-w-[120px]">${log.objective}</span>
                             <span class="${log.outcome === 'SUCCESS' ? 'text-emerald-500' : (log.outcome === 'FAILURE' ? 'text-red-500' : 'text-slate-500')} font-black">
                                ${log.outcome === 'SUCCESS' ? 'SUCCÈS' : (log.outcome === 'FAILURE' ? 'ÉCHEC' : 'N/A')}
                             </span>
                        </div>
                    </div>
                    <div class="bg-black/50 p-3 border border-white/10 h-full overflow-y-auto custom-scrollbar">
                        <div class="whitespace-pre-wrap text-xs font-mono text-slate-300 leading-relaxed">${log.report}</div>
                    </div>
                `;
                lucide.createIcons();
            },

            closeReportModal: function() {
                document.getElementById('report-modal').classList.add('hidden');
                state.activeReportId = null;
            },

            copyReport: function() {
                const log = state.logs.find(l => l.id === state.activeReportId);
                if(!log) return;
                const text = `RAPPORT MISSION ${log.objective}\nSL: ${log.sl} (${log.squad})\nRESULTAT: ${log.outcome}\nDATE: ${new Date(log.timestamp.seconds*1000).toLocaleString()}\n\nCONTENU:\n${log.report}`;
                navigator.clipboard.writeText(text).then(() => alert("Rapport copié !"));
            },

            // --- RENDER ENGINE ---
            render: function() {
                const root = document.getElementById('app');
                // Remove loading
                const loader = document.getElementById('loading-screen');
                if (loader && state.user) loader.remove();

                // View Routing
                if (state.view === 'LANDING') this.renderLanding();
                else if (state.view === 'STAFF') this.renderStaff();
                else if (state.view === 'SL') this.renderSL();

                lucide.createIcons();
            },

            renderLanding: function() {
                const root = document.getElementById('app');
                if (!document.getElementById('squad-grid-landing')) {
                    root.innerHTML = document.getElementById('tpl-landing').innerHTML;
                }
                
                // Render Squads Grid
                const container = document.getElementById('squad-grid-landing');
                if(container) {
                    container.innerHTML = SQUADS_CONFIG.map(s => {
                        const data = state.squads[s.id] || {};
                        const isActive = data.status === 'ACTIVE';
                        const isAssigned = data.status === 'ASSIGNED';
                        
                        let classes = `relative p-4 text-left transition-all border h-32 flex flex-col justify-between group `;
                        let statusTxt = "DISPO";
                        let statusCol = "text-mil-green";

                        if (isAssigned) {
                            classes += "border-mil-yellow/50 bg-yellow-900/10 animate-pulse cursor-pointer hover:border-white/20";
                            statusTxt = "ORDRE REÇU";
                            statusCol = "text-mil-yellow";
                        } else if (isActive) {
                            classes += "border-slate-800 bg-black opacity-50 cursor-not-allowed";
                            statusTxt = "EN MISSION";
                            statusCol = "text-mil-red";
                        } else {
                            classes += "border-slate-800 bg-slate-900/30 hover:border-white/20 cursor-pointer";
                        }

                        // Onclick - USING openSLLogin WRAPPER
                        const action = isActive ? '' : `onclick="window.app.openSLLogin('${s.id}')"`;

                        return `
                        <button ${action} class="${classes}" ${isActive ? 'disabled' : ''}>
                            <div class="flex justify-between items-start w-full">
                                <span class="text-xs font-bold uppercase ${statusCol} tracking-wider">${statusTxt}</span>
                                <div class="w-2 h-2 rounded-full ${s.color.replace('bg-', 'bg-')}"></div>
                            </div>
                            <div>
                                <h3 class="text-2xl font-black text-white uppercase">${s.name}</h3>
                                <p class="text-[10px] text-slate-500 font-mono">${s.freq} MHz</p>
                            </div>
                            ${data.sl ? `<div class="absolute bottom-2 right-2 text-right"><div class="text-[9px] text-slate-500 uppercase">Leader</div><div class="text-xs font-bold text-white uppercase truncate max-w-[100px]">${data.sl}</div></div>` : ''}
                        </button>
                        `;
                    }).join('');
                }
            },

            renderStaff: function() {
                const root = document.getElementById('app');
                if (!document.getElementById('staff-squad-grid')) {
                    root.innerHTML = document.getElementById('tpl-staff').innerHTML;
                }

                // Safe update for header stats
                const totalEl = document.getElementById('total-effectif');
                if (totalEl) totalEl.innerText = Object.values(state.squads).reduce((acc, c) => acc + (parseInt(c.effectif)||0), 0);
                
                // Safe update for inputs only if not focused
                if(document.getElementById('em-adjoint-input') && document.activeElement.id !== 'em-adjoint-input') 
                    document.getElementById('em-adjoint-input').value = state.opSettings.adjoint || '';
                if(document.getElementById('em-stagiaire-input') && document.activeElement.id !== 'em-stagiaire-input') 
                    document.getElementById('em-stagiaire-input').value = state.opSettings.stagiaire || '';
                
                // Base Select - Only update if needed to prevent flickers
                const baseSel = document.getElementById('em-base-select');
                if(baseSel && baseSel.innerHTML.trim() === '') {
                    baseSel.innerHTML = '<option value="">-- SELECTIONNER --</option>' + OBJECTIVES.map(b => `<option value="${b}" ${state.opSettings.base===b?'selected':''}>${b}</option>`).join('');
                }
                if(baseSel) baseSel.value = state.opSettings.base || '';
                
                // CDS Container
                const cdsCount = state.opSettings.active_cds_count || 0;
                const cdsContainer = document.getElementById('cds-container');
                if(cdsContainer) {
                    let cdsHtml = '';
                    for(let i=1; i<=cdsCount; i++) {
                        cdsHtml += `<div class="flex items-center gap-1 bg-white/5 px-2 py-1 border border-white/10 rounded">
                            <span class="text-[10px] font-bold text-[#66fcf1] uppercase mr-2">CHEF DE SECTION ${i}</span>
                            ${SQUADS_CONFIG.map(s => {
                                const squadData = state.squads[s.id] || {};
                                const isMine = squadData.cds_owner === `CDS ${i}`;
                                const isOthers = squadData.cds_owner && !isMine;
                                return `<button onclick="window.app.toggleCDS('${s.id}', ${i})" class="text-[9px] px-1.5 py-0.5 font-bold uppercase border transition-colors ${isMine ? 'bg-emerald-500 text-black border-emerald-500' : (isOthers ? 'bg-black text-slate-600 border-slate-800 cursor-not-allowed' : 'bg-transparent text-slate-400 border-slate-600 hover:border-white')}" ${isOthers?'disabled':''}>${s.name.substring(0,1)}</button>`;
                            }).join('')}
                        </div>`;
                    }
                    cdsContainer.innerHTML = cdsHtml;
                }

                const container = document.getElementById('squad-container');
                if(container) {
                    container.innerHTML = SQUADS_CONFIG.map(s => {
                        const d = state.squads[s.id] || {};
                        let border = "border-white/10", dot = "bg-slate-600", alert = "";
                        if(d.rtbStatus==='REQUESTED') { border="border-orange-500 animate-pulse"; alert=`<div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-orange-600 text-black text-xs font-bold px-3 py-1 rounded shadow-lg animate-bounce z-10">REQ: RTB</div>`; }
                        else if(d.status==='ACTIVE') { border="border-emerald-500/50"; dot="bg-emerald-500"; }
                        
                        const cdsBadge = d.cds_owner ? `<div class="absolute top-2 right-2 bg-indigo-500 text-white text-[9px] font-bold px-1.5 py-0.5 rounded uppercase">${d.cds_owner}</div>` : '';

                        return `<div class="military-box ${border} p-3 flex flex-col gap-2 min-h-[160px]">
                            ${alert} ${cdsBadge}
                            <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                            <div class="flex justify-between items-start"><div class="flex items-center gap-2"><div class="w-2 h-2 rounded-sm ${dot}"></div><h3 class="text-lg font-black uppercase tracking-wider text-white">${s.name}</h3><span class="text-[10px] font-mono text-mil-cyan bg-[#1f2833] px-1">${s.freq}</span></div><input type="number" inputmode="numeric" pattern="[0-9]*" onchange="window.app.updateSquad('${s.id}', 'effectif', this.value)" class="w-10 bg-black border border-slate-700 text-center font-bold text-white focus:border-mil-cyan outline-none text-sm" value="${d.effectif||''}" placeholder="0"></div>
                            <div class="grid grid-cols-2 gap-2 mt-1">
                                <div class="relative"><label class="text-[8px] uppercase text-slate-500 block mb-0.5">Chef d'Escouade</label><input list="sl-suggestions-list" type="text" onchange="window.app.updateSquad('${s.id}', 'sl', this.value)" class="w-full bg-[#1f2833] border ${d.sl?'border-white/40 text-white':'border-slate-700 text-slate-500'} text-xs py-1.5 px-2 uppercase outline-none focus:border-mil-cyan font-bold" placeholder="RECHERCHE..." value="${d.sl||''}"></div>
                                <div class="relative"><label class="text-[8px] uppercase text-slate-500 block mb-0.5">Objectif</label><select onchange="window.app.updateSquad('${s.id}', 'objective', this.value)" class="w-full bg-[#1f2833] border border-slate-700 text-xs py-1.5 px-2 uppercase text-white outline-none focus:border-mil-cyan appearance-none"><option value="">-- NÉANT --</option>${OBJECTIVES.map(o => `<option value="${o}" ${d.objective===o?'selected':''}>${o}</option>`).join('')}</select></div>
                            </div>
                            <div class="flex-1 flex flex-col justify-end gap-2"><div class="w-full bg-black/40 border border-white/5 p-1.5 min-h-[30px] flex items-center"><i data-lucide="activity" class="w-3 h-3 text-slate-600 mr-2 shrink-0"></i><span class="text-[10px] text-mil-cyan font-mono truncate w-full uppercase">${d.sitrep || 'AUCUN RAPPORT'}</span></div>
                            ${d.rtbStatus === 'REQUESTED' ? `<div class="flex gap-2"><button onclick="window.app.approveRTB('${s.id}', true)" class="flex-1 bg-emerald-900/80 hover:bg-emerald-800 text-white text-[10px] py-1 font-bold border border-emerald-700">ACCORDER</button><button onclick="window.app.approveRTB('${s.id}', false)" class="flex-1 bg-red-900/80 hover:bg-red-800 text-white text-[10px] py-1 font-bold border border-red-700">REFUSER</button></div>` : ''}
                            </div>
                            ${d.sl ? `<button onclick="if(confirm('Terminer mission ${s.name}?')) window.app.endMission('${s.id}', 'FIN EM')" class="absolute bottom-2 right-2 p-1 text-red-500/50 hover:text-red-500 transition-colors"><i data-lucide="log-out" class="w-4 h-4"></i></button>` : ''}
                        </div>`;
                    }).join('');
                }
                
                const lbContainer = document.getElementById('leaderboard-container');
                if(lbContainer) {
                    const counts = {}; state.logs.forEach(l => { counts[l.sl] = (counts[l.sl]||0)+1; });
                    lbContainer.innerHTML = Object.entries(counts).sort((a,b)=>b[1]-a[1]).map(([n,c],i) => `<div class="flex justify-between items-center py-1 border-b border-white/5 text-xs"><div class="flex items-center gap-2"><span class="text-slate-500 w-4">${i+1}.</span><span class="text-slate-300 font-bold">${n}</span></div><span class="text-mil-cyan">${c}</span></div>`).join('');
                }

                const logsContainer = document.getElementById('logs-container');
                if(logsContainer) {
                    logsContainer.innerHTML = state.logs.map(l => {
                        let icon = 'help-circle', col = 'border-slate-500';
                        if(l.outcome === 'SUCCESS') { icon = 'check-circle'; col = 'border-emerald-500'; }
                        else if(l.outcome === 'FAILURE') { icon = 'x-circle'; col = 'border-red-500'; }
                        return `<div onclick="window.app.openReportModal('${l.id}')" class="bg-white/5 p-2 border-l-2 ${col} cursor-pointer hover:bg-white/10 transition-colors"><div class="flex justify-between mb-1 items-center"><div class="flex items-center gap-2"><i data-lucide="${icon}" class="w-3 h-3"></i><span class="font-bold text-[#66fcf1] text-[10px] uppercase">${l.sl}</span><span class="text-[9px] text-slate-400 uppercase">(${l.squad})</span></div><span class="text-[9px] text-slate-500 font-mono">${l.timestamp ? new Date(l.timestamp.seconds*1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</span></div><div class="text-[10px] text-slate-300 uppercase truncate">${l.report.split('\n')[0]}</div></div>`;
                    }).join('');
                }
            },
            
            renderSitrepModal: function() {
                const container = document.getElementById('sitrep-form-content');
                const d = state.sitrepData;
                let html = '';
                if (state.activeSitrepForm === 'CONTACT') {
                    html = `
                        ${this.renderOptionGrid('type', ['INFANTERIE', 'VÉHICULE', 'BLINDÉ', 'HÉLICO'], d.type)}
                        <div class="mt-4"><label class="text-[10px] text-slate-500 font-bold uppercase">NOMBRE</label><input type="number" id="sr-count" inputmode="numeric" pattern="[0-9]*" class="w-full bg-black border border-slate-600 p-4 text-white text-lg font-bold outline-none touch-input" placeholder="1"></div>
                        <div class="mt-4">${this.renderOptionGrid('attitude', ['HOSTILE', 'NEUTRE', 'INCONNU'], d.attitude)}</div>
                        <div class="grid grid-cols-2 gap-4 mt-4">
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase">DIST (m)</label><input type="number" id="sr-dist" inputmode="numeric" pattern="[0-9]*" class="w-full bg-black border border-slate-600 p-4 text-white text-lg font-bold outline-none touch-input" placeholder="200"></div>
                            <div><label class="text-[10px] text-slate-500 font-bold uppercase">AZIMUT</label><input type="text" id="sr-azi" inputmode="decimal" class="w-full bg-black border border-slate-600 p-4 text-white text-lg font-bold outline-none touch-input" placeholder="360"></div>
                        </div>
                    `;
                } else if (state.activeSitrepForm === 'MEDICAL') {
                    html = `
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-red-900/20 p-2 border border-red-900/50"><label class="text-[10px] text-red-500 font-bold uppercase">ALPHA (GRAVE)</label><input id="sr-alpha" type="number" inputmode="numeric" pattern="[0-9]*" class="w-full bg-black border border-red-900/50 p-4 text-white text-xl font-bold touch-input" placeholder="0"></div>
                            <div class="bg-yellow-900/20 p-2 border border-yellow-900/50"><label class="text-[10px] text-yellow-500 font-bold uppercase">BRAVO (LÉGER)</label><input id="sr-bravo" type="number" inputmode="numeric" pattern="[0-9]*" class="w-full bg-black border border-yellow-900/50 p-4 text-white text-xl font-bold touch-input" placeholder="0"></div>
                        </div>
                        <div class="mt-4">${this.renderOptionGrid('evasan', ['NON', 'OUI'], d.evasan ? 'OUI' : 'NON')}</div>
                        <div class="mt-4"><label class="text-[10px] text-slate-500 font-bold uppercase">LZ / POS</label><input type="text" id="sr-lz" class="w-full bg-black border border-slate-600 p-4 text-white text-lg outline-none touch-input" placeholder="Grille"></div>
                    `;
                } else if (state.activeSitrepForm === 'LOG') {
                    html = `
                        <div><label class="text-[10px] text-slate-500 font-bold uppercase">TYPE</label><input type="text" id="sr-item" class="w-full bg-black border border-slate-600 p-4 text-white text-lg outline-none touch-input" placeholder="Munitions..."></div>
                        <div class="mt-4">${this.renderOptionGrid('urgency', ['NORMAL', 'URGENT', 'CRITIQUE'], d.urgency)}</div>
                        <div class="mt-4"><label class="text-[10px] text-slate-500 font-bold uppercase">POS</label><input type="text" id="sr-loc" class="w-full bg-black border border-slate-600 p-4 text-white text-lg outline-none touch-input" placeholder="Ma position"></div>
                    `;
                } else {
                    html = `<div><label class="text-[10px] text-slate-500 font-bold uppercase">INFO COMPLÉMENTAIRE</label><input type="text" id="sr-manual" class="w-full bg-black border border-slate-600 p-4 text-white text-lg outline-none touch-input" placeholder="${d.defaultMsg}"></div>`;
                }
                container.innerHTML = html;
            },
            renderSL: function() {
                document.getElementById('app').innerHTML = document.getElementById('tpl-sl').innerHTML;
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                if(!squadId) return this.logout();
                const squad = state.squads[squadId];
                const config = SQUADS_CONFIG.find(s => s.id === squadId);
                
                const baseDisp = document.getElementById('sl-base-display');
                if(baseDisp) baseDisp.innerText = state.opSettings.base || 'N/A';
                const adjDisp = document.getElementById('sl-adjoint-display');
                if(adjDisp) adjDisp.innerText = state.opSettings.adjoint || 'N/A';
                
                document.getElementById('sl-squad-name').innerText = config.name;
                document.getElementById('sl-freq').innerText = config.freq;
                document.getElementById('sl-username').innerText = state.pseudo;
                document.getElementById('sl-objective').innerText = squad.objective || 'STANDBY';
                document.getElementById('sl-header').className = `p-4 ${config.color} bg-opacity-20 border-b border-white/10 flex justify-between items-end shrink-0 transition-colors duration-300`;
                
                if(squad.rtbStatus === 'APPROVED') document.getElementById('sl-rtb-status').innerHTML = '<div class="text-emerald-500 font-black animate-pulse mb-1">RTB AUTORISÉ</div>';
                else if(squad.rtbStatus === 'DENIED') document.getElementById('sl-rtb-status').innerHTML = '<div class="text-red-500 font-black mb-1">RTB REFUSÉ</div>';
                else if(squad.rtbStatus === 'REQUESTED') document.getElementById('sl-rtb-status').innerHTML = '<div class="text-yellow-500 font-bold mb-1">RTB EN ATTENTE...</div>';

                document.querySelectorAll('.tab-btn').forEach(btn => {
                    btn.className = `tab-btn flex-1 py-4 text-xs font-bold uppercase tracking-[0.15em] border-r border-white/5 hover:bg-white/5 ${btn.dataset.tab === state.slTab ? 'bg-white/10 text-white border-b-2 border-red-500' : 'text-slate-500'}`;
                });

                const linked = Object.entries(state.squads).filter(([id, s]) => id !== squadId && s.objective === squad.objective && s.status === 'ACTIVE');
                const lb = document.getElementById('tab-liaison');
                if(linked.length > 0) { lb.classList.remove('hidden'); lb.innerHTML = `<span class="flex items-center justify-center gap-2"><i data-lucide="link" class="w-3 h-3"></i> LIAISON</span>`; }
                else { lb.classList.add('hidden'); if(state.slTab === 'LIAISON') state.slTab = 'TACTIQUE'; }

                const container = document.getElementById('sl-content');
                if(state.slTab === 'TACTIQUE') {
                    container.innerHTML = `<div class="space-y-6 h-full flex flex-col">
                        <div class="grid grid-cols-2 gap-4 shrink-0">
                            <div class="military-box p-4 text-center"><div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div><div class="bg-white/5 text-[10px] uppercase font-bold tracking-[0.2em] text-white/50 px-2 py-1 mb-2 border-b border-white/5 flex items-center gap-2"><div class="w-1 h-3 bg-red-600"></div> EFFECTIF</div><div class="text-4xl font-mono font-bold text-white">${squad.effectif||0}</div></div>
                            <div class="military-box p-4 text-center"><div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div><div class="bg-white/5 text-[10px] uppercase font-bold tracking-[0.2em] text-white/50 px-2 py-1 mb-2 border-b border-white/5 flex items-center gap-2"><div class="w-1 h-3 bg-red-600"></div> DÉPART</div><div class="text-2xl font-mono text-white">${squad.startTime ? new Date(squad.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--'}</div></div>
                        </div>
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-3 text-[10px] uppercase font-bold text-slate-500 tracking-widest"><i data-lucide="activity" class="w-3 h-3"></i> C.R. Tactiques<div class="h-px bg-slate-800 flex-1"></div></div>
                            
                            <!-- JALONS DEBUT / FIN -->
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <button onclick="window.app.sitrepAction('depart', 'SIMPLE', 'TOP DÉPART')" class="bg-emerald-900/50 border border-emerald-500/50 hover:bg-emerald-500/20 active:scale-95 transition-all text-white p-4 flex flex-col items-center justify-center gap-2 relative overflow-hidden group">
                                    <i data-lucide="play" class="w-8 h-8 z-10 text-emerald-500"></i>
                                    <span class="font-bold text-sm text-center uppercase z-10 tracking-wider text-emerald-400">TOP DÉPART</span>
                                </button>
                                <button onclick="window.app.sitrepAction('retour', 'SIMPLE', 'RETOUR BASE')" class="bg-blue-900/50 border border-blue-500/50 hover:bg-blue-500/20 active:scale-95 transition-all text-white p-4 flex flex-col items-center justify-center gap-2 relative overflow-hidden group">
                                    <i data-lucide="home" class="w-8 h-8 z-10 text-blue-500"></i>
                                    <span class="font-bold text-sm text-center uppercase z-10 tracking-wider text-blue-400">RETOUR BASE</span>
                                </button>
                            </div>

                            <div class="grid grid-cols-2 gap-3 h-full pb-4">
                                ${[{id:'pos', label:'POSITION', icon:'map-pin', color:'bg-slate-800 border-slate-600', form:'SIMPLE'}, {id:'contact', label:'CONTACT', icon:'crosshair', color:'bg-red-900 border-red-600 animate-pulse', form:'CONTACT'}, {id:'med', label:'SANITAIRE', icon:'heart-pulse', color:'bg-orange-800 border-orange-600', form:'MEDICAL'}, {id:'log', label:'LOGISTIQUE', icon:'box', color:'bg-yellow-800 border-yellow-600', form:'LOG'}, {id:'rtb', label:'DEMANDE RTB', icon:'arrow-right', color:'bg-slate-700 border-slate-500', form:'RTB'}].map(b => `
                                    <button onclick="window.app.sitrepAction('${b.id}', '${b.form}', '${b.label}')" class="${b.color} bg-opacity-10 border hover:bg-opacity-20 active:scale-95 transition-all text-white p-4 flex flex-col items-center justify-center gap-2 relative overflow-hidden group">
                                        <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent pointer-events-none"></div>
                                        <i data-lucide="${b.icon}" class="w-8 h-8 z-10 opacity-80 group-hover:scale-110 transition-transform"></i>
                                        <span class="font-bold text-sm text-center uppercase z-10 tracking-wider">${b.label}</span>
                                    </button>
                                `).join('')}
                            </div>
                        </div>
                    </div>`;
                } else if(state.slTab === 'ESCOUADE') {
                    container.innerHTML = `<div class="space-y-4"><div class="flex justify-between items-center mb-2 pb-2 border-b border-white/10"><h3 class="text-white font-bold uppercase text-xs tracking-widest">Tableau des Effectifs</h3><button onclick="window.app.addMember()" class="bg-[#66fcf1] hover:bg-white text-black text-[10px] font-bold px-3 py-1.5 uppercase flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> Ajouter</button></div><div class="space-y-2">${(squad.members||[]).map((m,i)=>`<div class="bg-white/5 p-2 border border-white/5 flex items-center gap-2 group hover:border-white/20 transition-colors"><span class="text-[10px] text-slate-500 font-mono w-4">${i+1}</span><select onchange="window.app.updateMember(${i}, 'grade', this.value)" class="bg-black text-[#66fcf1] text-xs p-1 border border-slate-700 outline-none w-20 uppercase font-bold">${GRADES.map(g=>`<option value="${g}" ${m.grade===g?'selected':''}>${g}</option>`).join('')}</select><input type="text" onchange="window.app.updateMember(${i}, 'name', this.value)" value="${m.name}" class="bg-transparent text-white text-sm p-1 border-b border-transparent focus:border-[#66fcf1] outline-none flex-1 w-full uppercase"><select onchange="window.app.updateMember(${i}, 'role', this.value)" class="bg-black text-slate-300 text-[10px] p-1 border border-slate-700 outline-none w-28 uppercase">${ROLES.map(r=>`<option value="${r}" ${m.role===r?'selected':''}>${r}</option>`).join('')}</select><button onclick="window.app.removeMember(${i})" class="text-red-900 group-hover:text-red-500 p-2 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join('')}</div></div>`;
                } else if(state.slTab === 'RAPPORT') {
                    // GENERATION AUTOMATIQUE DU RAPPORT
                    const generatedReport = this.generateMilitaryReport(squad, "");
                    
                    container.innerHTML = `<div class="flex flex-col h-full"><div class="flex-1 overflow-y-auto mb-4 bg-black/20 border border-white/5 p-4"><div class="space-y-4 border-l border-slate-700 pl-4 ml-2">${(squad.missionHistory||[]).map(e=>`<div class="relative"><div class="absolute -left-[21px] top-1.5 w-2 h-2 rounded-full bg-slate-700 border border-black"></div><div class="text-[10px] text-slate-500 font-mono mb-0.5">${new Date(e.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</div><div class="text-sm text-white font-bold uppercase tracking-wide">${e.content}</div></div>`).join('')}</div></div><div class="mt-auto pt-4 border-t border-white/10"><div class="flex gap-4 mb-4 justify-center"><label class="flex items-center gap-2 cursor-pointer p-4 border border-white/10 bg-black/40 hover:bg-white/5 transition-colors w-1/2 justify-center"><input type="radio" name="mission-status" value="SUCCESS" checked class="accent-emerald-500 w-6 h-6"><span class="text-emerald-500 font-black uppercase text-lg">SUCCÈS</span></label><label class="flex items-center gap-2 cursor-pointer p-4 border border-white/10 bg-black/40 hover:bg-white/5 transition-colors w-1/2 justify-center"><input type="radio" name="mission-status" value="FAILURE" class="accent-red-500 w-6 h-6"><span class="text-red-500 font-black uppercase text-lg">ÉCHEC</span></label></div>
                    
                    <!-- ZONE DE TEXTE PRE-REMPLIE -->
                    <textarea id="final-report-input" class="w-full bg-black border border-slate-700 p-4 text-white text-xs mb-4 h-64 resize-none outline-none focus:border-red-500 uppercase font-mono touch-input leading-relaxed tracking-wide">${generatedReport}</textarea>
                    
                    <button onclick="window.app.sendEndMission()" class="w-full bg-red-900/80 hover:bg-red-800 text-white py-6 font-bold uppercase tracking-[0.2em] flex items-center justify-center gap-2 border border-red-700 text-xl"><i data-lucide="save"></i> CLÔTURER</button></div></div>`;
                } else if (state.slTab === 'LIAISON') {
                    container.innerHTML = `
                        <div class="space-y-4">
                            <div class="bg-indigo-900/20 border border-indigo-500/30 p-4 text-center mb-4">
                                <h3 class="text-indigo-400 font-bold uppercase tracking-widest text-xs mb-1">Groupe Tactique Lié</h3>
                                <div class="text-white text-lg font-black uppercase">OBJECTIF : ${squad.objective}</div>
                            </div>
                            <!-- Fréquence Jonction -->
                            <div class="military-box p-4 border-indigo-500/50 mb-4 bg-indigo-900/10">
                                <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                                <div class="flex items-center justify-between gap-4">
                                    <div class="flex items-center gap-2 text-indigo-300 font-bold uppercase text-xs tracking-widest"><i data-lucide="wifi" class="w-4 h-4"></i> Fréquence Jonction</div>
                                    <input type="text" placeholder="---.-" inputmode="decimal" onchange="window.app.updateSquad('${squadId}', 'junctionFreq', this.value)" class="bg-black border border-indigo-500/50 text-white text-center font-mono font-bold text-lg w-24 p-1 outline-none focus:border-white touch-input" value="${squad.junctionFreq || ''}">
                                </div>
                                <p class="text-[9px] text-indigo-400/50 mt-2 text-center uppercase">Définissez la fréquence commune pour ce groupe.</p>
                            </div>
                            <div class="grid gap-4">
                                ${linked.map(([lid, ls]) => {
                                    const lConf = SQUADS_CONFIG.find(s => s.id === lid);
                                    return `
                                    <div class="military-box p-4 border-indigo-500/20">
                                        <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="flex items-center gap-3">
                                                <div class="w-3 h-3 ${lConf.color.replace('bg-', 'bg-')}"></div>
                                                <div><h4 class="text-xl font-black text-white uppercase">${lConf.name}</h4><div class="text-[10px] text-slate-400 uppercase font-mono">FREQ: <span class="text-white">${lConf.freq} MHz</span></div></div>
                                            </div>
                                            <div class="text-right"><div class="text-[9px] uppercase text-slate-500">Leader</div><div class="text-sm font-bold text-indigo-400 uppercase">${ls.sl}</div></div>
                                        </div>
                                        ${ls.junctionFreq ? `<div class="mb-3 bg-indigo-500/20 border border-indigo-500/50 p-2 text-center"><div class="text-[8px] text-indigo-300 uppercase tracking-widest">PROPOSE JONCTION SUR</div><div class="text-lg font-mono font-bold text-white">${ls.junctionFreq} <span class="text-xs">MHz</span></div></div>` : ''}
                                        <div class="bg-black/40 p-3 border border-white/5">
                                            <div class="text-[9px] uppercase text-slate-500 mb-1">Dernier SITREP</div>
                                            <div class="text-sm font-mono text-white uppercase">${ls.sitrep || 'R.A.S'}</div>
                                            <div class="text-[9px] text-slate-600 text-right mt-1 font-mono">${ls.lastSitrepTime ? new Date(ls.lastSitrepTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</div>
                                        </div>
                                    </div>
                                    `
                                }).join('')}
                            </div>
                        </div>
                    `;
                }
            },
            
            // Helper pour construire les boutons de sélection
            renderOptionGrid: function(key, options, current) {
                return `<div class="grid grid-cols-2 gap-2">
                    ${options.map(opt => `
                        <button onclick="window.app.setSitrepData('${key}', '${opt}')" class="p-4 border ${current === opt ? 'bg-white text-black font-bold border-white' : 'bg-black text-slate-400 border-slate-700 hover:border-white'} uppercase text-xs transition-colors">${opt}</button>
                    `).join('')}
                </div>`;
            }
        };

        // Boot
        App.init();
    </script>
</body>
</html>
