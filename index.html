<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>F.O.F TACTICAL NET</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Custom Styles & Tailwind Config -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700;800&display=swap');
        
        body {
            font-family: 'JetBrains Mono', monospace;
            background-color: #050505;
            color: #cbd5e1; /* slate-300 */
        }

        /* Scrollbar Tactique */
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: #0f1419; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }

        .glitch-effect {
            text-shadow: 2px 0 #7f1d1d, -2px 0 #047857;
        }
        
        .military-box {
            position: relative;
            background-color: #0f1419;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .military-box::before, .military-box::after {
            content: ''; position: absolute; width: 8px; height: 8px; pointer-events: none; transition: all 0.3s;
        }
        /* Coins */
        .corner-tl { position: absolute; top: -1px; left: -1px; width: 8px; height: 8px; border-top: 2px solid rgba(255,255,255,0.3); border-left: 2px solid rgba(255,255,255,0.3); }
        .corner-tr { position: absolute; top: -1px; right: -1px; width: 8px; height: 8px; border-top: 2px solid rgba(255,255,255,0.3); border-right: 2px solid rgba(255,255,255,0.3); }
        .corner-bl { position: absolute; bottom: -1px; left: -1px; width: 8px; height: 8px; border-bottom: 2px solid rgba(255,255,255,0.3); border-left: 2px solid rgba(255,255,255,0.3); }
        .corner-br { position: absolute; bottom: -1px; right: -1px; width: 8px; height: 8px; border-bottom: 2px solid rgba(255,255,255,0.3); border-right: 2px solid rgba(255,255,255,0.3); }

        .animate-pulse-fast { animation: pulse 1.5s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        
        /* Background Grid */
        .bg-grid {
            background-image: linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 40px 40px;
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'mil-black': '#050505',
                        'mil-dark': '#0f1419',
                        'mil-green': '#10b981',
                        'mil-red': '#ef4444',
                        'mil-yellow': '#eab308',
                        'mil-cyan': '#66fcf1',
                    }
                }
            }
        }
    </script>
</head>
<body class="h-screen overflow-hidden flex flex-col">

    <!-- Container Principal -->
    <div id="app" class="flex-1 relative flex flex-col h-full">
        <!-- Loading Screen -->
        <div id="loading-screen" class="absolute inset-0 z-50 bg-mil-black flex items-center justify-center">
            <div class="text-center">
                <div class="text-mil-cyan font-black text-2xl tracking-[0.5em] animate-pulse">INITIALISATION...</div>
                <div class="text-slate-600 text-xs mt-2 font-mono">CONNEXION SECURE FIREBASE</div>
            </div>
        </div>
    </div>

    <!-- TEMPLATES (Hidden, used by JS to render) -->
    
    <!-- 1. LOGIN / LANDING -->
    <template id="tpl-landing">
        <div class="absolute inset-0 bg-grid pointer-events-none"></div>
        <div class="relative z-10 flex flex-col items-center justify-center h-full p-4 overflow-y-auto">
            
            <!-- Titre -->
            <div class="text-center mb-12">
                <h1 class="text-6xl md:text-8xl font-black text-white uppercase tracking-tighter mb-2 glitch-effect select-none">
                    <span class="text-red-700">FOF</span>NET
                </h1>
                <div class="flex justify-center gap-4 text-[10px] uppercase tracking-[0.3em] text-slate-500">
                    <span>Secure V.3.2</span><span>•</span><span>Ops Center</span><span>•</span><span class="text-emerald-500 animate-pulse">Online</span>
                </div>
            </div>

            <!-- Grille Choix -->
            <div class="grid grid-cols-1 md:grid-cols-12 gap-6 max-w-6xl w-full">
                <!-- Bouton Staff -->
                <div class="md:col-span-3">
                    <button onclick="window.app.openLoginModal('STAFF')" class="military-box w-full h-32 hover:border-red-600 hover:bg-red-900/10 transition-all group p-6 flex flex-col items-center justify-center cursor-pointer">
                        <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                        <i data-lucide="shield" class="w-10 h-10 text-slate-600 group-hover:text-red-600 mb-2 transition-colors"></i>
                        <span class="text-sm font-bold text-slate-400 group-hover:text-white uppercase tracking-widest">État-Major</span>
                    </button>
                </div>

                <!-- Grille Squads -->
                <div class="md:col-span-9 grid grid-cols-2 md:grid-cols-4 gap-3" id="squad-grid-landing">
                    <!-- Injecté via JS -->
                </div>
            </div>
        </div>

        <!-- Modal Login -->
        <div id="login-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="military-box p-8 max-w-md w-full border-white/20">
                <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                <button onclick="window.app.closeModal()" class="absolute top-2 right-2 text-slate-500 hover:text-white"><i data-lucide="x"></i></button>
                
                <div id="modal-content" class="text-center">
                    <!-- Injecté via JS -->
                </div>
            </div>
        </div>
    </template>

    <!-- 2. INTERFACE STAFF (EM) -->
    <template id="tpl-staff">
        <div class="flex flex-col h-full bg-[#0b0c10]">
            <!-- Header -->
            <header class="bg-[#1f2833] border-b border-[#45a29e]/30 p-2 flex justify-between items-center shadow-lg z-20 shrink-0">
                <div class="flex items-center gap-4">
                    <div class="flex items-center gap-2 px-4 border-r border-slate-600">
                        <i data-lucide="shield" class="text-red-600 w-6 h-6"></i>
                        <span class="font-bold text-white tracking-widest uppercase hidden md:inline">QG TACTIQUE</span>
                    </div>
                    
                    <!-- Settings EM -->
                    <div class="flex gap-2 md:gap-4 items-center">
                        <div class="flex flex-col">
                            <label class="text-[9px] text-[#66fcf1] uppercase">Base</label>
                            <select id="em-base-select" onchange="window.app.updateSettings('base', this.value)" class="bg-[#0b0c10] text-white border border-slate-600 text-xs py-1 px-2 uppercase outline-none focus:border-[#66fcf1]">
                                <!-- Options Bases -->
                            </select>
                        </div>
                        <div class="flex flex-col w-24 md:w-32">
                            <label class="text-[9px] text-slate-400 uppercase">Adjoint</label>
                            <input type="text" onchange="window.app.updateSettings('adjoint', this.value)" id="em-adjoint-input" class="bg-[#0b0c10] text-white border border-slate-600 text-xs py-1 px-2 uppercase outline-none" list="sl-suggestions">
                        </div>
                        <div class="flex flex-col w-24 md:w-32 hidden md:flex">
                            <label class="text-[9px] text-slate-400 uppercase">Stagiaire</label>
                            <input type="text" onchange="window.app.updateSettings('stagiaire', this.value)" id="em-stagiaire-input" class="bg-[#0b0c10] text-white border border-slate-600 text-xs py-1 px-2 uppercase outline-none" list="sl-suggestions">
                        </div>
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right hidden sm:block">
                        <div class="text-[9px] text-slate-500 uppercase font-bold">Effectifs</div>
                        <div id="total-effectif" class="text-xl font-bold text-[#66fcf1] leading-none">0</div>
                    </div>
                    <button onclick="window.app.logout()" class="bg-red-900/20 text-red-200 p-2 border border-red-900/50 hover:bg-red-900/50 transition"><i data-lucide="log-out" class="w-5 h-5"></i></button>
                </div>
            </header>

            <!-- Main Content -->
            <main class="flex-1 p-2 overflow-hidden flex gap-2">
                <!-- Grid Squads -->
                <div class="flex-1 overflow-y-auto pr-1" id="staff-squad-grid">
                    <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-2" id="squad-container">
                        <!-- Squad Cards Injected Here -->
                    </div>
                </div>

                <!-- Sidebar Logs -->
                <div class="hidden lg:flex w-72 flex-col gap-2">
                    <!-- Stats -->
                    <div class="military-box h-1/3 flex flex-col p-0">
                        <div class="bg-white/5 text-[10px] uppercase font-bold tracking-[0.2em] text-white/50 px-2 py-1 border-b border-white/5 flex items-center gap-2"><div class="w-1 h-3 bg-red-600"></div> CLASSEMENT</div>
                        <div class="overflow-y-auto flex-1 p-2" id="leaderboard-container"></div>
                    </div>
                    <!-- Logs -->
                    <div class="military-box flex-1 flex flex-col p-0">
                        <div class="bg-white/5 text-[10px] uppercase font-bold tracking-[0.2em] text-white/50 px-2 py-1 border-b border-white/5 flex items-center gap-2"><div class="w-1 h-3 bg-red-600"></div> FLUX OPS</div>
                        <div class="flex-1 overflow-y-auto p-2 space-y-2" id="logs-container"></div>
                    </div>
                </div>
            </main>
        </div>
    </template>

    <!-- 3. INTERFACE SQUAD LEADER (SL) -->
    <template id="tpl-sl">
        <div class="flex flex-col h-full bg-[#050505]">
            <!-- Top Bar -->
            <div class="bg-[#1a1c23] p-2 flex justify-between items-center text-[10px] uppercase border-b border-white/5 shrink-0">
                <div class="flex gap-4 text-slate-400">
                    <span>BASE: <span class="text-white font-bold" id="sl-base-display">N/A</span></span>
                    <span>ADC: <span class="text-white font-bold" id="sl-adjoint-display">N/A</span></span>
                </div>
                <button onclick="window.app.logout()" class="text-red-500 font-bold border border-red-900/50 px-2 hover:bg-red-900/20">DÉCONNEXION</button>
            </div>

            <!-- Header Mission -->
            <div id="sl-header" class="p-4 bg-opacity-20 border-b border-white/10 flex justify-between items-end shrink-0 transition-colors duration-300">
                <div>
                    <h2 class="text-4xl font-black uppercase text-white tracking-tighter" id="sl-squad-name">ALPHA</h2>
                    <div class="flex items-center gap-3 text-xs font-bold text-white/50">
                        <span class="flex items-center gap-1 bg-black/30 px-2 py-1"><i data-lucide="radio" class="w-3 h-3"></i> <span id="sl-freq">00.0</span> MHz</span>
                        <span class="flex items-center gap-1 bg-black/30 px-2 py-1"><i data-lucide="user" class="w-3 h-3"></i> <span id="sl-username">...</span></span>
                    </div>
                </div>
                <div class="text-right">
                    <div id="sl-rtb-status"></div>
                    <div class="text-[10px] uppercase text-white/40 mb-1 tracking-widest">Objectif</div>
                    <div class="text-2xl font-black text-white bg-white/5 px-3 py-1 border-l-4 border-yellow-500 uppercase" id="sl-objective">STANDBY</div>
                </div>
            </div>

            <!-- Tabs -->
            <div class="flex border-b border-white/10 bg-[#0a0a0a] shrink-0" id="sl-tabs">
                <button onclick="window.app.setTab('TACTIQUE')" class="tab-btn flex-1 py-4 text-xs font-bold uppercase tracking-[0.15em] border-r border-white/5 hover:bg-white/5 text-slate-500" data-tab="TACTIQUE">TACTIQUE</button>
                <button onclick="window.app.setTab('ESCOUADE')" class="tab-btn flex-1 py-4 text-xs font-bold uppercase tracking-[0.15em] border-r border-white/5 hover:bg-white/5 text-slate-500" data-tab="ESCOUADE">ESCOUADE</button>
                <button onclick="window.app.setTab('RAPPORT')" class="tab-btn flex-1 py-4 text-xs font-bold uppercase tracking-[0.15em] border-r border-white/5 hover:bg-white/5 text-slate-500" data-tab="RAPPORT">RAPPORT</button>
                <button onclick="window.app.setTab('LIAISON')" id="tab-liaison" class="tab-btn flex-1 py-4 text-xs font-bold uppercase tracking-[0.15em] hidden border-r border-white/5 hover:bg-white/5 text-indigo-500 bg-indigo-900/10" data-tab="LIAISON">LIAISON</button>
            </div>

            <!-- Content Area -->
            <div class="flex-1 overflow-y-auto p-4 bg-[#0d0e12] relative" id="sl-content">
                <!-- Injected by JS -->
            </div>
        </div>

        <!-- Modal SITREP Form -->
        <div id="sitrep-modal" class="fixed inset-0 bg-black/90 z-50 hidden flex items-center justify-center p-4 backdrop-blur-sm">
            <div class="military-box w-full max-w-sm p-6 border-white/30">
                <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                <div class="flex justify-between items-center mb-6 border-b border-white/10 pb-2">
                    <h3 class="text-xl font-black text-white uppercase tracking-widest" id="sitrep-title">RAPPORT</h3>
                    <button onclick="window.app.closeSitrepModal()"><i data-lucide="x" class="w-6 h-6 text-slate-500 hover:text-white"></i></button>
                </div>
                <div id="sitrep-form-content" class="space-y-4"></div>
                <button onclick="window.app.submitSitrep()" class="w-full bg-white text-black font-black uppercase py-4 hover:bg-slate-200 transition-colors tracking-widest mt-4">TRANSMETTRE</button>
            </div>
        </div>
    </template>

    <!-- Firebase Modules & App Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, query, orderBy, addDoc, serverTimestamp, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";

        // --- CONSTANTES ---
        const STAFF_LIST = ["MJR.Lazarevic", "WhiZzper", "Papa Yankee", "Le_S", "teckilgfx", "Eksypa", "GlockTrooper77", "Pitivier le vrai"];
        const BASES = ["USS FREEDOM (Porte-Avions)", "FOB OMEGA", "BASE AÉRIENNE 104", "CAMP DE L'EST", "POSITION AVANCÉE", "QG MOBILE", "DESTROYER"];
        const OBJECTIVES = ["ALABAMA", "ALASKA", "ARIZONA", "ARKANSAS", "APOLLO", "AMBER", "AUGUSTA", "ATLAS", "AUSTIN", "BALTIMORE", "BROOKLYN", "CALIFORNIA", "CHICAGO", "COLORADO", "CONCORDE", "CONNECTICUT", "DALLAS", "DAYTON", "DELAWARE", "DENVER", "FLORIDA", "FRESNO", "GEORGIA", "HAWAI", "HOUSTON", "IDAHO", "ILLINOIS", "INDIANA", "IOWA", "JUNKYARD", "KANSAS", "KENTUCKY", "LAS VEGAS", "LIBERTY", "LOGISTIQUE", "LOS ANGELES", "LOUISIANA", "MAINE", "MARYLAND", "MASSACHUSETTS", "MIAMI", "MICHIGAN", "MINNESOTA", "MISSISSIPPI", "MISSOURI", "MONTANA", "MONROE", "NASHVILLE", "NEBRASKA", "NEVADA", "NEW HAMPSHIRE", "NEW JERSEY", "NEW MEXICO", "NEW ORLEANS", "NEW YORK", "NORTH CAROLINA", "NORTH DAKOTA", "OHIO", "OKLAHOMA", "OMAHA", "OREGON", "PENNSYLVANIA", "PHILADELPHIA", "PHOENIX", "PORTLAND", "PRINCETON", "PROVIDENCE", "REDHAWK", "RELAI DE L'EST", "RELAI ST PHILIPPE", "RICHEMOND", "RHODE ISLAND", "SAN ANTONIO", "SAN DIEGO", "SAN JOSE", "SEATTLE", "SOUTH CAROLINA", "SOUTH DAKOTA", "SPIRIT", "TAMPA", "TENNESSEE", "TEXAS", "TITAN", "TOUR D'ENTRE-DEUX", "TOUR DE REGINA", "TOUR DES PINS", "TOUR ESTRAPADE", "TUCSON", "TULSA", "UTAH", "VERMONT", "VESPER", "VIRGINIA", "WASHINGTON", "WEST VIRGINIA", "WISCONSIN", "WYOMING", "DEFENSE DE BASE", "SECURITE EM", "RECONNAISSANCE", "DEMINAGE"];
        const SQUADS_CONFIG = [
            { id: 'alpha', name: 'Alpha', freq: '32.0', color: 'bg-emerald-800', border: 'border-emerald-600', text: 'text-emerald-500' },
            { id: 'bravo', name: 'Bravo', freq: '33.0', color: 'bg-blue-900', border: 'border-blue-600', text: 'text-blue-500' },
            { id: 'charlie', name: 'Charlie', freq: '34.0', color: 'bg-violet-900', border: 'border-violet-600', text: 'text-violet-500' },
            { id: 'delta', name: 'Delta', freq: '35.0', color: 'bg-amber-900', border: 'border-amber-600', text: 'text-amber-500' },
            { id: 'echo', name: 'Echo', freq: '36.0', color: 'bg-teal-900', border: 'border-teal-600', text: 'text-teal-500' },
            { id: 'foxtrot', name: 'Foxtrot', freq: '37.0', color: 'bg-orange-900', border: 'border-orange-600', text: 'text-orange-500' },
            { id: 'golf', name: 'Golf', freq: '38.0', color: 'bg-rose-900', border: 'border-rose-600', text: 'text-rose-500' },
            { id: 'hotel', name: 'Hotel', freq: '39.0', color: 'bg-slate-700', border: 'border-slate-500', text: 'text-slate-400' },
            { id: 'logis', name: 'Logis', freq: '45.0', color: 'bg-yellow-900', border: 'border-yellow-700', text: 'text-yellow-600' },
            { id: 'blindé', name: 'Blindé', freq: '65.0', color: 'bg-stone-800', border: 'border-stone-500', text: 'text-stone-400' },
            { id: 'faucon', name: 'Faucon', freq: '47.0', color: 'bg-sky-900', border: 'border-sky-600', text: 'text-sky-500' },
        ];
        const GRADES = ["Recrue", "Sdt", "1.Cl", "Cpl", "Cch", "Sgt", "Sgt-C", "Adj", "Adj-C", "Maj", "Aspi", "S-Lt", "Lt", "Cne"];
        const ROLES = ["Fusilier", "Médic", "AT", "MG", "Radio", "Sapeur", "Sniper", "Pilote", "Chef de Groupe"];
        
        // Liste de suggestion SL (modifiable)
        const BASE_SL_SUGGESTIONS = ["Nico75", "-Sangui-", "[VDK]KEBABIERdu96", "ALEX2801CH", "ATOMIC W4RRIOR", "Benjamin", "Can am", "CCH.Le_S", "Darkspartan9337", "EagleClaw", "Fez", "Five Scream", "Flo.", "Gin", "Hybris95", "Jej", "KenBlook5129", "l Ryüjinn l", "Lapuchk6766", "LittleEvil", "lkurd26", "MASKER84", "Mirai", "MULTIFRUIT1492", "Natrium", "Nettoyeur", "oahhmz", "Panchito6097", "Pixc361", "Pokeur", "Poulet998", "Sucreblé", "Tatar", "Teckil", "TF3 SLAYER", "Théotime", "Tinky Winky", "Tong", "valoche_0", "ValouTekmi", "Waze toxic", "Exam94", "xYourGalactic-I", "Yogun", "Zl Deathstro", "zlatanqlf"];

        // --- FIREBASE INIT ---
        // Utilisation des variables globales si présentes, sinon config projet
        const firebaseConfig = (typeof __firebase_config !== 'undefined') ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyD3caoQgjcnsyyh-fCSFHwbErPpPvip8p4",
            authDomain: "squadnet-ops.firebaseapp.com",
            projectId: "squadnet-ops",
            storageBucket: "squadnet-ops.firebasestorage.app",
            messagingSenderId: "453589699258",
            appId: "1:453589699258:web:85befe0f3da6495c685083",
            measurementId: "G-103J7PX3NF"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = (typeof __app_id !== 'undefined') ? __app_id : 'squadnet-ops';

        // --- STATE MANAGEMENT SIMPLE ---
        const state = {
            user: null,
            role: null, // 'STAFF' ou 'SL'
            view: 'LANDING',
            pseudo: localStorage.getItem('fof_ops_pseudo') || '',
            squads: {},
            opSettings: {},
            logs: [],
            slTab: 'TACTIQUE', // TACTIQUE, ESCOUADE, RAPPORT, LIAISON
            activeSitrepForm: null,
            sitrepData: {},
            selectedSquadId: null // Pour le modal login
        };

        // --- APP LOGIC ---
        const App = {
            init: function() {
                this.bindEvents();
                this.initAuth();
                this.render(); // Initial render
            },

            bindEvents: function() {
                // Expose methods globally for HTML onclicks
                window.app = this;
            },

            initAuth: async function() {
                onAuthStateChanged(auth, (u) => {
                    state.user = u;
                    if (u) {
                        this.startListeners();
                        // Auto-reconnect logic
                        if (state.pseudo && state.view === 'LANDING') {
                            // On attend que les squads soient chargés par le listener
                            setTimeout(() => this.checkAutoLogin(), 1000); 
                        }
                    }
                    this.render();
                });

                // Sign In
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    try { await signInWithCustomToken(auth, __initial_auth_token); } 
                    catch (e) { await signInAnonymously(auth); }
                } else {
                    await signInAnonymously(auth);
                }
            },

            startListeners: function() {
                // Squads
                onSnapshot(collection(db, 'artifacts', appId, 'public', 'data', 'squads'), (snapshot) => {
                    const data = {};
                    snapshot.docs.forEach(doc => data[doc.id] = doc.data());
                    state.squads = data;
                    this.checkAutoLogin(); // Check again on data update
                    this.render();
                });
                // Settings path fixed
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'ops'), (d) => {
                    state.opSettings = d.data() || {};
                    this.render();
                });
                // Logs
                const qLogs = query(collection(db, 'artifacts', appId, 'public', 'data', 'mission_logs'), orderBy('timestamp', 'desc'));
                onSnapshot(qLogs, (snapshot) => {
                    state.logs = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    this.render();
                });
            },

            checkAutoLogin: function() {
                if (state.view !== 'LANDING' || !state.pseudo) return;
                // Si le joueur est un SL actif dans une escouade
                const myActiveSquad = Object.entries(state.squads).find(([id, s]) => s.sl === state.pseudo && s.status === 'ACTIVE');
                if (myActiveSquad) {
                    state.role = 'SL';
                    state.view = 'SL';
                    this.render();
                } else if (STAFF_LIST.includes(state.pseudo)) {
                    // Optional auto-login staff
                }
            },

            // --- NAVIGATION & LOGIN ---
            
            openLoginModal: function(type) {
                const modal = document.getElementById('login-modal');
                const content = document.getElementById('modal-content');
                modal.classList.remove('hidden');
                
                let html = '';
                if (type === 'STAFF') {
                    html = `
                        <div class="mb-6"><i data-lucide="shield" class="w-16 h-16 text-red-700 mx-auto"></i><h2 class="text-xl font-bold text-white uppercase">Accès EM</h2></div>
                        <input type="text" id="login-pseudo" class="w-full bg-black border border-slate-700 p-4 text-white text-center outline-none mb-4 uppercase" placeholder="IDENTIFIANT" value="${state.pseudo}">
                        <button onclick="window.app.login('STAFF')" class="w-full bg-red-900/80 hover:bg-red-800 text-white font-bold py-3 border border-red-700">CONNEXION</button>
                    `;
                } else if (type === 'SL') {
                    const squad = SQUADS_CONFIG.find(s => s.id === state.selectedSquadId);
                    const sData = state.squads[state.selectedSquadId];
                    const isAssigned = sData.status === 'ASSIGNED';
                    
                    html = `
                        <div class="mb-6"><i data-lucide="target" class="w-16 h-16 text-emerald-600 mx-auto"></i><h2 class="text-xl font-bold text-white uppercase">ID SQUAD LEADER</h2><div class="text-emerald-500 font-bold">${squad.name}</div></div>
                    `;

                    if (isAssigned) {
                        html += `
                            <p class="text-slate-500 text-xs uppercase mb-2">Opérateur Assigné</p>
                            <div class="text-2xl font-bold text-white bg-white/5 p-4 border border-white/10 mb-6">${sData.sl}</div>
                            <button onclick="window.app.login('SL_CONFIRM')" class="w-full bg-emerald-900/80 hover:bg-emerald-800 text-white font-bold py-3 border border-emerald-700">CONFIRMER IDENTITÉ</button>
                        `;
                    } else {
                        html += `
                            <div class="relative mb-4">
                                <input list="sl-suggestions-list" type="text" id="login-pseudo" class="w-full bg-black border border-slate-700 p-4 text-white text-center outline-none uppercase" placeholder="VOTRE GAMERTAG" value="${state.pseudo}">
                                <datalist id="sl-suggestions-list">${BASE_SL_SUGGESTIONS.map(s => `<option value="${s}">`).join('')}</datalist>
                            </div>
                            <div id="new-profile-alert" class="text-xs text-yellow-500 mb-4 hidden">Nouveau profil détecté</div>
                            <button onclick="window.app.login('SL_MANUAL')" class="w-full bg-blue-900/80 hover:bg-blue-800 text-white font-bold py-3 border border-blue-700">VALIDER</button>
                        `;
                    }
                }
                content.innerHTML = html;
                lucide.createIcons();
            },

            openSLLogin: function(squadId) {
                state.selectedSquadId = squadId;
                this.openLoginModal('SL');
            },

            closeModal: function() {
                document.getElementById('login-modal').classList.add('hidden');
                state.selectedSquadId = null;
            },

            login: async function(mode) {
                const pseudoInput = document.getElementById('login-pseudo');
                const pseudo = pseudoInput ? pseudoInput.value.trim() : state.squads[state.selectedSquadId]?.sl;
                
                if (!pseudo) return alert("Identifiant requis");

                if (mode === 'STAFF') {
                    if (!STAFF_LIST.some(n => n.toLowerCase() === pseudo.toLowerCase())) return alert("Accès refusé");
                    state.role = 'STAFF';
                    state.view = 'STAFF';
                } else {
                    // SL Login
                    const squadId = state.selectedSquadId;
                    const squadData = state.squads[squadId];
                    
                    await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), {
                        ...squadData,
                        sl: pseudo,
                        name: SQUADS_CONFIG.find(s => s.id === squadId).name,
                        startTime: new Date().toISOString(),
                        status: 'ACTIVE',
                        members: squadData.members || [],
                        missionHistory: []
                    }, { merge: true });

                    state.role = 'SL';
                    state.view = 'SL';
                }

                state.pseudo = pseudo;
                localStorage.setItem('fof_ops_pseudo', pseudo);
                this.closeModal();
                this.render();
            },

            logout: function() {
                state.role = null;
                state.view = 'LANDING';
                state.pseudo = '';
                state.slTab = 'TACTIQUE';
                localStorage.removeItem('fof_ops_pseudo');
                this.render();
            },

            // --- UPDATES & ACTIONS ---

            updateSettings: async function(key, val) {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'config', 'ops'), {
                    ...state.opSettings, [key]: val
                }, { merge: true });
            },

            updateSquad: async function(squadId, field, val) {
                // SAFE CHECK: Check if squad data exists before accessing properties
                const currentSquad = state.squads[squadId] || {};
                const updates = { [field]: val };
                // Logic reset
                if (field === 'sl') {
                    if (val === "") {
                        updates.status = 'DISPO';
                        updates.startTime = null;
                        updates.sitrep = '';
                        updates.rtbStatus = 'NONE';
                        updates.junctionFreq = '';
                    } else if (currentSquad.status !== 'ACTIVE') {
                        updates.status = 'ASSIGNED';
                        updates.startTime = null;
                    }
                }
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), updates, { merge: true });
            },

            endMission: async function(squadId, report = "R.A.S") {
                const sData = state.squads[squadId];
                // Log
                await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'mission_logs'), {
                    sl: sData.sl, squad: sData.name, objective: sData.objective,
                    startTime: sData.startTime, endTime: new Date().toISOString(),
                    report: report, timestamp: serverTimestamp(), managedBy: state.pseudo
                });
                // Reset
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), {
                    sl: '', objective: '', status: 'DISPO', startTime: null, sitrep: '',
                    members: [], missionHistory: [], rtbStatus: 'NONE', junctionFreq: ''
                });
                
                if (state.role === 'SL') this.logout();
            },

            // --- SL ACTIONS ---
            
            setTab: function(tab) {
                state.slTab = tab;
                this.render();
            },

            openSitrepModal: function(formType, defaultLabel) {
                state.activeSitrepForm = formType;
                state.sitrepData = { defaultMsg: defaultLabel };
                this.renderSitrepModal();
                document.getElementById('sitrep-modal').classList.remove('hidden');
            },

            closeSitrepModal: function() {
                document.getElementById('sitrep-modal').classList.add('hidden');
                state.activeSitrepForm = null;
            },

            requestRTB: async function(squadId) {
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), {
                    rtbStatus: 'REQUESTED', sitrep: 'DEMANDE DE RTB',
                    missionHistory: arrayUnion({ type: 'ALERT', content: "REQ RTB", time: new Date().toISOString() })
                });
            },

            approveRTB: async function(squadId, approved) {
                const status = approved ? 'APPROVED' : 'DENIED';
                const msg = approved ? 'RTB ACCORDÉ' : 'RTB REFUSÉ';
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), {
                    rtbStatus: status,
                    missionHistory: arrayUnion({ type: 'CMD', content: msg, time: new Date().toISOString() })
                });
            },

            submitSitrep: async function() {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                if (!squadId) return;

                let msg = "";
                const data = state.sitrepData;
                
                // Build message based on form inputs (collected via onchange events stored in state.sitrepData via DOM)
                const getVal = (id) => document.getElementById(id)?.value || '';
                const getCheck = (id) => document.getElementById(id)?.checked;

                if (state.activeSitrepForm === 'CONTACT') {
                    msg = `CONTACT: ${getVal('sr-count')}x ${getVal('sr-type')} (${getVal('sr-attitude')}) | Dist: ${getVal('sr-dist')}m | Azi: ${getVal('sr-azi')}`;
                } else if (state.activeSitrepForm === 'MEDICAL') {
                    msg = `SANITAIRE: A:${getVal('sr-alpha')} / B:${getVal('sr-bravo')} | EVASAN: ${getCheck('sr-evasan')?'OUI':'NON'} | LZ: ${getVal('sr-lz')}`;
                } else if (state.activeSitrepForm === 'LOG') {
                    msg = `LOG: ${getVal('sr-item')} (${getVal('sr-urgency')}) à ${getVal('sr-loc')}`;
                } else {
                    msg = getVal('sr-manual') || data.defaultMsg;
                }

                const timestamp = new Date().toISOString();
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), {
                    sitrep: msg, lastSitrepTime: timestamp,
                    missionHistory: arrayUnion({ type: 'SITREP', content: msg, time: timestamp })
                });

                this.closeSitrepModal();
            },

            addMember: async function() {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                const members = state.squads[squadId].members || [];
                if (members.length >= 10) return;
                members.push({ name: 'SOLDAT', grade: 'Sdt', role: 'Fusilier' });
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), { members, effectif: members.length });
            },

            updateMember: async function(idx, field, val) {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                const members = [...state.squads[squadId].members];
                members[idx][field] = val;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), { members });
            },

            removeMember: async function(idx) {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                const members = state.squads[squadId].members.filter((_, i) => i !== idx);
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'squads', squadId), { members, effectif: members.length });
            },

            // --- RENDER ENGINE ---
            render: function() {
                const root = document.getElementById('app');
                // Remove loading
                const loader = document.getElementById('loading-screen');
                if (loader && state.user) loader.remove();

                // View Routing
                if (state.view === 'LANDING') this.renderLanding();
                else if (state.view === 'STAFF') this.renderStaff();
                else if (state.view === 'SL') this.renderSL();

                lucide.createIcons();
            },

            renderLanding: function() {
                const root = document.getElementById('app');
                if (!document.getElementById('squad-grid-landing')) {
                    root.innerHTML = document.getElementById('tpl-landing').innerHTML;
                }
                
                // Render Squads Grid
                const container = document.getElementById('squad-grid-landing');
                if(container) {
                    container.innerHTML = SQUADS_CONFIG.map(s => {
                        const data = state.squads[s.id] || {};
                        const isActive = data.status === 'ACTIVE';
                        const isAssigned = data.status === 'ASSIGNED';
                        
                        let classes = `relative p-4 text-left transition-all border h-32 flex flex-col justify-between group `;
                        let statusTxt = "DISPO";
                        let statusCol = "text-mil-green";

                        if (isAssigned) {
                            classes += "border-mil-yellow/50 bg-yellow-900/10 animate-pulse cursor-pointer hover:border-white/20";
                            statusTxt = "ORDRE REÇU";
                            statusCol = "text-mil-yellow";
                        } else if (isActive) {
                            classes += "border-slate-800 bg-black opacity-50 cursor-not-allowed";
                            statusTxt = "EN MISSION";
                            statusCol = "text-mil-red";
                        } else {
                            classes += "border-slate-800 bg-slate-900/30 hover:border-white/20 cursor-pointer";
                        }

                        // Onclick - USING openSLLogin WRAPPER
                        const action = isActive ? '' : `onclick="window.app.openSLLogin('${s.id}')"`;

                        return `
                        <button ${action} class="${classes}" ${isActive ? 'disabled' : ''}>
                            <div class="flex justify-between items-start w-full">
                                <span class="text-xs font-bold uppercase ${statusCol} tracking-wider">${statusTxt}</span>
                                <div class="w-2 h-2 rounded-full ${s.color.replace('bg-', 'bg-')}"></div>
                            </div>
                            <div>
                                <h3 class="text-2xl font-black text-white uppercase">${s.name}</h3>
                                <p class="text-[10px] text-slate-500 font-mono">${s.freq} MHz</p>
                            </div>
                            ${data.sl ? `<div class="absolute bottom-2 right-2 text-right"><div class="text-[9px] text-slate-500 uppercase">Leader</div><div class="text-xs font-bold text-white uppercase truncate max-w-[100px]">${data.sl}</div></div>` : ''}
                        </button>
                        `;
                    }).join('');
                }
            },

            renderStaff: function() {
                const root = document.getElementById('app');
                if (!document.getElementById('staff-squad-grid')) {
                    root.innerHTML = document.getElementById('tpl-staff').innerHTML;
                }

                // Update Header Stats & Inputs
                document.getElementById('total-effectif').innerText = Object.values(state.squads).reduce((acc, curr) => acc + (parseInt(curr.effectif)||0), 0);
                
                // Inputs values (only if not focused to avoid jumping)
                if(document.activeElement.id !== 'em-adjoint-input') document.getElementById('em-adjoint-input').value = state.opSettings.adjoint || '';
                if(document.activeElement.id !== 'em-stagiaire-input') document.getElementById('em-stagiaire-input').value = state.opSettings.stagiaire || '';
                if(document.activeElement.id !== 'em-base-select') {
                    const baseSel = document.getElementById('em-base-select');
                    baseSel.innerHTML = '<option value="">-- SELECTIONNER --</option>' + BASES.map(b => `<option value="${b}" ${state.opSettings.base===b?'selected':''}>${b}</option>`).join('');
                }

                // Render Grid
                const container = document.getElementById('squad-container');
                container.innerHTML = SQUADS_CONFIG.map(s => {
                    const d = state.squads[s.id] || {};
                    let border = "border-white/10";
                    let dot = "bg-slate-600";
                    let rtbAlert = "";

                    if (d.rtbStatus === 'REQUESTED') {
                        border = "border-orange-500 shadow-[0_0_15px_rgba(249,115,22,0.3)] animate-pulse";
                        rtbAlert = `<div class="absolute -top-3 left-1/2 -translate-x-1/2 bg-orange-600 text-black text-xs font-bold px-3 py-1 rounded shadow-lg animate-bounce z-10">REQ: RTB</div>`;
                    } else if (d.status === 'ACTIVE') {
                        border = "border-emerald-500/50 shadow-[0_0_10px_rgba(16,185,129,0.1)]";
                        dot = "bg-emerald-500";
                    } else if (d.status === 'ASSIGNED') {
                        border = "border-yellow-500/50";
                        dot = "bg-yellow-500 animate-pulse";
                    }

                    return `
                    <div class="military-box ${border} p-3 flex flex-col gap-2 min-h-[160px]">
                        ${rtbAlert}
                        <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                        
                        <div class="flex justify-between items-start">
                            <div class="flex items-center gap-2">
                                <div class="w-2 h-2 rounded-sm ${dot}"></div>
                                <h3 class="text-lg font-black uppercase tracking-wider text-white">${s.name}</h3>
                                <span class="text-[10px] font-mono text-mil-cyan bg-[#1f2833] px-1">${s.freq}</span>
                            </div>
                            <input type="number" onchange="window.app.updateSquad('${s.id}', 'effectif', this.value)" class="w-10 bg-black border border-slate-700 text-center font-bold text-white focus:border-mil-cyan outline-none text-sm" value="${d.effectif||''}" placeholder="0">
                        </div>

                        <div class="grid grid-cols-2 gap-2 mt-1">
                            <div class="relative">
                                <label class="text-[8px] uppercase text-slate-500 block mb-0.5">Chef d'Escouade</label>
                                <input list="sl-suggestions-list" type="text" onchange="window.app.updateSquad('${s.id}', 'sl', this.value)" class="w-full bg-[#1f2833] border ${d.sl?'border-white/40 text-white':'border-slate-700 text-slate-500'} text-xs py-1.5 px-2 uppercase outline-none focus:border-mil-cyan font-bold" placeholder="RECHERCHE..." value="${d.sl||''}">
                            </div>
                            <div class="relative">
                                <label class="text-[8px] uppercase text-slate-500 block mb-0.5">Objectif</label>
                                <select onchange="window.app.updateSquad('${s.id}', 'objective', this.value)" class="w-full bg-[#1f2833] border border-slate-700 text-xs py-1.5 px-2 uppercase text-white outline-none focus:border-mil-cyan appearance-none">
                                    <option value="">-- NÉANT --</option>
                                    ${OBJECTIVES.map(o => `<option value="${o}" ${d.objective===o?'selected':''}>${o}</option>`).join('')}
                                </select>
                            </div>
                        </div>

                        <div class="flex-1 flex flex-col justify-end gap-2">
                            <div class="w-full bg-black/40 border border-white/5 p-1.5 min-h-[30px] flex items-center">
                                <i data-lucide="activity" class="w-3 h-3 text-slate-600 mr-2 shrink-0"></i>
                                <span class="text-[10px] text-mil-cyan font-mono truncate w-full uppercase">${d.sitrep || 'AUCUN RAPPORT'}</span>
                            </div>
                            ${d.rtbStatus === 'REQUESTED' ? `
                            <div class="flex gap-2">
                                <button onclick="window.app.approveRTB('${s.id}', true)" class="flex-1 bg-emerald-900/80 hover:bg-emerald-800 text-white text-[10px] py-1 font-bold border border-emerald-700">ACCORDER</button>
                                <button onclick="window.app.approveRTB('${s.id}', false)" class="flex-1 bg-red-900/80 hover:bg-red-800 text-white text-[10px] py-1 font-bold border border-red-700">REFUSER</button>
                            </div>` : ''}
                        </div>

                        ${d.sl ? `<button onclick="if(confirm('Terminer mission ${s.name}?')) window.app.endMission('${s.id}', 'FIN EM')" class="absolute bottom-2 right-2 p-1 text-red-500/50 hover:text-red-500 transition-colors"><i data-lucide="log-out" class="w-4 h-4"></i></button>` : ''}
                    </div>
                    `;
                }).join('');

                // Render Leaderboard
                const counts = {};
                state.logs.forEach(l => { counts[l.sl] = (counts[l.sl] || 0) + 1; });
                const sorted = Object.entries(counts).sort((a,b) => b[1] - a[1]);
                document.getElementById('leaderboard-container').innerHTML = sorted.map(([n, c], i) => `
                    <div class="flex justify-between items-center py-1 border-b border-white/5 text-xs">
                        <div class="flex items-center gap-2"><span class="text-slate-500 w-4">${i+1}.</span><span class="text-slate-300 font-bold">${n}</span></div>
                        <span class="text-mil-cyan">${c}</span>
                    </div>
                `).join('');

                // Render Logs
                document.getElementById('logs-container').innerHTML = state.logs.map(l => `
                    <div class="bg-white/5 p-2 border-l-2 border-slate-500">
                        <div class="flex justify-between mb-1">
                            <span class="font-bold text-mil-cyan text-[10px] uppercase">${l.sl}</span>
                            <span class="text-[9px] text-slate-500 font-mono">${l.timestamp ? new Date(l.timestamp.seconds * 1000).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</span>
                        </div>
                        <div class="text-[10px] text-slate-300 uppercase">${l.report}</div>
                    </div>
                `).join('');
            },

            renderSL: function() {
                const root = document.getElementById('app');
                if (!document.getElementById('sl-header')) {
                    root.innerHTML = document.getElementById('tpl-sl').innerHTML;
                }

                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                if (!squadId) return this.logout();
                const squad = state.squads[squadId];
                const config = SQUADS_CONFIG.find(s => s.id === squadId);

                // Header Info
                document.getElementById('sl-base-display').innerText = state.opSettings.base || 'N/A';
                document.getElementById('sl-adjoint-display').innerText = state.opSettings.adjoint || 'N/A';
                document.getElementById('sl-squad-name').innerText = config.name;
                document.getElementById('sl-freq').innerText = config.freq;
                document.getElementById('sl-username').innerText = state.pseudo;
                document.getElementById('sl-objective').innerText = squad.objective || 'STANDBY';
                
                // Header Style
                const header = document.getElementById('sl-header');
                // remove old classes
                header.className = `p-4 ${config.color} bg-opacity-20 border-b border-white/10 flex justify-between items-end shrink-0 transition-colors duration-300`;

                // RTB Status
                let rtbHtml = '';
                if (squad.rtbStatus === 'APPROVED') rtbHtml = '<div class="text-emerald-500 font-black animate-pulse mb-1">RTB AUTORISÉ</div>';
                else if (squad.rtbStatus === 'DENIED') rtbHtml = '<div class="text-red-500 font-black mb-1">RTB REFUSÉ</div>';
                else if (squad.rtbStatus === 'REQUESTED') rtbHtml = '<div class="text-yellow-500 font-bold mb-1">RTB EN ATTENTE...</div>';
                document.getElementById('sl-rtb-status').innerHTML = rtbHtml;

                // Tabs State
                document.querySelectorAll('.tab-btn').forEach(btn => {
                    const isActive = btn.dataset.tab === state.slTab;
                    btn.className = `tab-btn flex-1 py-4 text-xs font-bold uppercase tracking-[0.15em] border-r border-white/5 hover:bg-white/5 ${isActive ? 'bg-white/10 text-white border-b-2 border-red-500' : 'text-slate-500'}`;
                });

                // Linked Squads Logic
                const linked = Object.entries(state.squads).filter(([id, s]) => id !== squadId && s.objective === squad.objective && s.status === 'ACTIVE');
                const liaisonBtn = document.getElementById('tab-liaison');
                if (linked.length > 0) {
                    liaisonBtn.classList.remove('hidden');
                    liaisonBtn.innerHTML = `<span class="flex items-center justify-center gap-2"><i data-lucide="link" class="w-3 h-3"></i> LIAISON</span>`;
                } else {
                    liaisonBtn.classList.add('hidden');
                    if (state.slTab === 'LIAISON') state.slTab = 'TACTIQUE';
                }

                // Content
                const container = document.getElementById('sl-content');
                if (state.slTab === 'TACTIQUE') {
                    container.innerHTML = `
                        <div class="space-y-6 h-full flex flex-col">
                            <div class="grid grid-cols-2 gap-4 shrink-0">
                                <div class="military-box p-4 text-center"><div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div><div class="bg-white/5 text-[10px] uppercase font-bold tracking-[0.2em] text-white/50 px-2 py-1 mb-2 border-b border-white/5 flex items-center gap-2"><div class="w-1 h-3 bg-red-600"></div> EFFECTIF</div><div class="text-4xl font-mono font-bold text-white">${squad.effectif||0}</div></div>
                                <div class="military-box p-4 text-center"><div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div><div class="bg-white/5 text-[10px] uppercase font-bold tracking-[0.2em] text-white/50 px-2 py-1 mb-2 border-b border-white/5 flex items-center gap-2"><div class="w-1 h-3 bg-red-600"></div> DÉPART</div><div class="text-2xl font-mono text-white">${squad.startTime ? new Date(squad.startTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : '--:--'}</div></div>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-3 text-[10px] uppercase font-bold text-slate-500 tracking-widest"><i data-lucide="activity" class="w-3 h-3"></i> C.R. Tactiques<div class="h-px bg-slate-800 flex-1"></div></div>
                                <div class="grid grid-cols-2 gap-3 h-full pb-4">
                                    ${[
                                        {id:'pos', label:'POSITION TENUE', icon:'map-pin', color:'bg-emerald-800 border-emerald-600', form:'SIMPLE'},
                                        {id:'move', label:'EN MOUVEMENT', icon:'navigation', color:'bg-blue-800 border-blue-600', form:'SIMPLE'},
                                        {id:'contact', label:'CONTACT ENI', icon:'crosshair', color:'bg-red-900 border-red-600 animate-pulse', form:'CONTACT'},
                                        {id:'med', label:'SANITAIRE', icon:'heart-pulse', color:'bg-orange-800 border-orange-600', form:'MEDICAL'},
                                        {id:'log', label:'LOGISTIQUE', icon:'box', color:'bg-yellow-800 border-yellow-600', form:'LOG'},
                                        {id:'rtb', label:'DEMANDE RTB', icon:'arrow-right', color:'bg-slate-700 border-slate-500', form:'RTB'}
                                    ].map(b => `
                                        <button onclick="window.app.sitrepAction('${b.id}', '${b.form}', '${b.label}')" class="${b.color} bg-opacity-10 border hover:bg-opacity-20 active:scale-95 transition-all text-white p-4 flex flex-col items-center justify-center gap-2 relative overflow-hidden group">
                                            <div class="absolute inset-0 bg-gradient-to-t from-black/50 to-transparent pointer-events-none"></div>
                                            <i data-lucide="${b.icon}" class="w-6 h-6 z-10 opacity-80 group-hover:scale-110 transition-transform"></i>
                                            <span class="font-bold text-xs text-center uppercase z-10 tracking-wider">${b.label}</span>
                                        </button>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                    `;
                } else if (state.slTab === 'ESCOUADE') {
                    container.innerHTML = `
                        <div class="space-y-4">
                            <div class="flex justify-between items-center mb-2 pb-2 border-b border-white/10">
                                <h3 class="text-white font-bold uppercase text-xs tracking-widest">Tableau des Effectifs</h3>
                                <button onclick="window.app.addMember()" class="bg-[#66fcf1] hover:bg-white text-black text-[10px] font-bold px-3 py-1.5 uppercase flex items-center gap-1"><i data-lucide="user" class="w-3 h-3"></i> Ajouter</button>
                            </div>
                            <div class="space-y-2">
                                ${(squad.members || []).map((m, i) => `
                                    <div class="bg-white/5 p-2 border border-white/5 flex items-center gap-2 group hover:border-white/20 transition-colors">
                                        <span class="text-[10px] text-slate-500 font-mono w-4">${i+1}</span>
                                        <select onchange="window.app.updateMember(${i}, 'grade', this.value)" class="bg-black text-[#66fcf1] text-xs p-1 border border-slate-700 outline-none w-20 uppercase font-bold">
                                            ${GRADES.map(g => `<option value="${g}" ${m.grade===g?'selected':''}>${g}</option>`).join('')}
                                        </select>
                                        <input type="text" onchange="window.app.updateMember(${i}, 'name', this.value)" value="${m.name}" class="bg-transparent text-white text-sm p-1 border-b border-transparent focus:border-[#66fcf1] outline-none flex-1 w-full uppercase">
                                        <select onchange="window.app.updateMember(${i}, 'role', this.value)" class="bg-black text-slate-300 text-[10px] p-1 border border-slate-700 outline-none w-28 uppercase">
                                            ${ROLES.map(r => `<option value="${r}" ${m.role===r?'selected':''}>${r}</option>`).join('')}
                                        </select>
                                        <button onclick="window.app.removeMember(${i})" class="text-red-900 group-hover:text-red-500 p-2 transition-colors"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    `;
                } else if (state.slTab === 'LIAISON') {
                    container.innerHTML = `
                        <div class="space-y-4">
                            <div class="bg-indigo-900/20 border border-indigo-500/30 p-4 text-center mb-4">
                                <h3 class="text-indigo-400 font-bold uppercase tracking-widest text-xs mb-1">Groupe Tactique Lié</h3>
                                <div class="text-white text-lg font-black uppercase">OBJECTIF : ${squad.objective}</div>
                            </div>
                            <!-- Fréquence Jonction -->
                            <div class="military-box p-4 border-indigo-500/50 mb-4 bg-indigo-900/10">
                                <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                                <div class="flex items-center justify-between gap-4">
                                    <div class="flex items-center gap-2 text-indigo-300 font-bold uppercase text-xs tracking-widest"><i data-lucide="wifi" class="w-4 h-4"></i> Fréquence Jonction</div>
                                    <input type="text" placeholder="---.-" onchange="window.app.updateSquad('${squadId}', 'junctionFreq', this.value)" class="bg-black border border-indigo-500/50 text-white text-center font-mono font-bold text-lg w-24 p-1 outline-none focus:border-white" value="${squad.junctionFreq || ''}">
                                </div>
                                <p class="text-[9px] text-indigo-400/50 mt-2 text-center uppercase">Définissez la fréquence commune pour ce groupe.</p>
                            </div>
                            <div class="grid gap-4">
                                ${linked.map(([lid, ls]) => {
                                    const lConf = SQUADS_CONFIG.find(s => s.id === lid);
                                    return `
                                    <div class="military-box p-4 border-indigo-500/20">
                                        <div class="corner-tl"></div><div class="corner-tr"></div><div class="corner-bl"></div><div class="corner-br"></div>
                                        <div class="flex justify-between items-start mb-4">
                                            <div class="flex items-center gap-3">
                                                <div class="w-3 h-3 ${lConf.color.replace('bg-', 'bg-')}"></div>
                                                <div><h4 class="text-xl font-black text-white uppercase">${lConf.name}</h4><div class="text-[10px] text-slate-400 uppercase font-mono">FREQ: <span class="text-white">${lConf.freq} MHz</span></div></div>
                                            </div>
                                            <div class="text-right"><div class="text-[9px] uppercase text-slate-500">Leader</div><div class="text-sm font-bold text-indigo-400 uppercase">${ls.sl}</div></div>
                                        </div>
                                        ${ls.junctionFreq ? `<div class="mb-3 bg-indigo-500/20 border border-indigo-500/50 p-2 text-center"><div class="text-[8px] text-indigo-300 uppercase tracking-widest">PROPOSE JONCTION SUR</div><div class="text-lg font-mono font-bold text-white">${ls.junctionFreq} <span class="text-xs">MHz</span></div></div>` : ''}
                                        <div class="bg-black/40 p-3 border border-white/5">
                                            <div class="text-[9px] uppercase text-slate-500 mb-1">Dernier SITREP</div>
                                            <div class="text-sm font-mono text-white uppercase">${ls.sitrep || 'R.A.S'}</div>
                                            <div class="text-[9px] text-slate-600 text-right mt-1 font-mono">${ls.lastSitrepTime ? new Date(ls.lastSitrepTime).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) : ''}</div>
                                        </div>
                                    </div>
                                    `
                                }).join('')}
                            </div>
                        </div>
                    `;
                } else if (state.slTab === 'RAPPORT') {
                    container.innerHTML = `
                        <div class="flex flex-col h-full">
                            <div class="flex-1 overflow-y-auto mb-4 bg-black/20 border border-white/5 p-4">
                                <div class="space-y-4 border-l border-slate-700 pl-4 ml-2">
                                    ${(squad.missionHistory || []).map(e => `
                                        <div class="relative">
                                            <div class="absolute -left-[21px] top-1.5 w-2 h-2 rounded-full bg-slate-700 border border-black"></div>
                                            <div class="text-[10px] text-slate-500 font-mono mb-0.5">${new Date(e.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</div>
                                            <div class="text-sm text-white font-bold uppercase tracking-wide">${e.content}</div>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                            <div class="mt-auto pt-4 border-t border-white/10">
                                <textarea id="final-report-input" class="w-full bg-black border border-slate-700 p-3 text-white text-sm mb-4 h-24 resize-none outline-none focus:border-red-500 uppercase font-mono" placeholder="NOTE DE FIN DE MISSION..."></textarea>
                                <button onclick="window.app.sendEndMission()" class="w-full bg-red-900/80 hover:bg-red-800 text-white py-4 font-bold uppercase tracking-[0.2em] flex items-center justify-center gap-2 border border-red-700"><i data-lucide="save"></i> Signer & Clôturer</button>
                            </div>
                        </div>
                    `;
                }
            },

            renderSitrepModal: function() {
                // Logic to inject inputs inside modal based on state.activeSitrepForm
                const container = document.getElementById('sitrep-form-content');
                const type = state.activeSitrepForm;
                let html = '';

                if (type === 'CONTACT') {
                    html = `
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] text-slate-500 font-bold">TYPE</label><select id="sr-type" class="w-full bg-black border border-slate-600 p-2 text-white text-sm"><option>INFANTERIE</option><option>VÉHICULE</option><option>BLINDÉ</option><option>HÉLICO</option></select></div>
                            <div><label class="text-[10px] text-slate-500 font-bold">NOMBRE</label><input type="number" id="sr-count" class="w-full bg-black border border-slate-600 p-2 text-white text-sm" placeholder="1"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            <div><label class="text-[10px] text-slate-500 font-bold">ATTITUDE</label><select id="sr-attitude" class="w-full bg-black border border-slate-600 p-2 text-white text-sm"><option>HOSTILE</option><option>NEUTRE</option></select></div>
                            <div><label class="text-[10px] text-slate-500 font-bold">DIST (m)</label><input type="number" id="sr-dist" class="w-full bg-black border border-slate-600 p-2 text-white text-sm" placeholder="200"></div>
                        </div>
                        <div><label class="text-[10px] text-slate-500 font-bold">AZIMUT</label><input type="text" id="sr-azi" class="w-full bg-black border border-slate-600 p-2 text-white text-sm" placeholder="NORD / 360"></div>
                    `;
                } else if (type === 'MEDICAL') {
                    html = `
                        <div class="grid grid-cols-2 gap-4">
                            <div class="bg-red-900/20 p-2 border border-red-900/50"><label class="text-[10px] text-red-500 font-bold">ALPHA (GRAVE)</label><input id="sr-alpha" type="number" class="w-full bg-black border border-red-900/50 p-2 text-white" placeholder="0"></div>
                            <div class="bg-yellow-900/20 p-2 border border-yellow-900/50"><label class="text-[10px] text-yellow-500 font-bold">BRAVO (LÉGER)</label><input id="sr-bravo" type="number" class="w-full bg-black border border-yellow-900/50 p-2 text-white" placeholder="0"></div>
                        </div>
                        <div class="flex items-center gap-2 py-2"><input type="checkbox" id="sr-evasan" class="w-5 h-5 accent-red-500"><label for="sr-evasan" class="text-sm font-bold uppercase text-white">EVASAN REQUISE</label></div>
                        <div><label class="text-[10px] text-slate-500 font-bold">LZ / POS</label><input type="text" id="sr-lz" class="w-full bg-black border border-slate-600 p-2 text-white text-sm" placeholder="Grille"></div>
                    `;
                } else if (type === 'LOG') {
                    html = `
                        <div><label class="text-[10px] text-slate-500 font-bold">TYPE</label><input type="text" id="sr-item" class="w-full bg-black border border-slate-600 p-2 text-white text-sm" placeholder="Munitions..."></div>
                        <div><label class="text-[10px] text-slate-500 font-bold">URGENCE</label><select id="sr-urgency" class="w-full bg-black border border-slate-600 p-2 text-white text-sm"><option>NORMAL</option><option>URGENT</option><option>CRITIQUE</option></select></div>
                        <div><label class="text-[10px] text-slate-500 font-bold">POS</label><input type="text" id="sr-loc" class="w-full bg-black border border-slate-600 p-2 text-white text-sm" placeholder="Ma position"></div>
                    `;
                } else if (type === 'SIMPLE') {
                    html = `<div><label class="text-[10px] text-slate-500 font-bold">INFO COMPLÉMENTAIRE</label><input type="text" id="sr-manual" class="w-full bg-black border border-slate-600 p-2 text-white text-sm" placeholder="${state.sitrepData.defaultMsg}"></div>`;
                }
                container.innerHTML = html;
            },

            sitrepAction: function(id, form, label) {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                if (id === 'rtb') {
                    if(confirm("Demander RTB à l'EM ?")) this.requestRTB(squadId);
                } else {
                    this.openSitrepModal(form, label);
                }
            },

            sendEndMission: function() {
                const squadId = Object.keys(state.squads).find(k => state.squads[k].sl === state.pseudo);
                const note = document.getElementById('final-report-input').value;
                if(confirm("Clôturer la mission ?")) this.endMission(squadId, note);
            }
        };

        // Boot
        App.init();
    </script>
</body>
</html>
